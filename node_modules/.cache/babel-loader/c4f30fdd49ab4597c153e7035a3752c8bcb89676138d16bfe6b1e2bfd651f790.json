{"ast":null,"code":"/*!\n * @antv/g-plugin-canvas-renderer\n * @description A G plugin of renderer implementation with Canvas2D API\n * @version 2.1.3\n * @date 10/24/2024, 7:58:21 AM\n * @author AntVis\n * @docs https://g.antv.antgroup.com/\n */\nimport _defineProperty from '@babel/runtime/helpers/defineProperty';\nimport _objectSpread from '@babel/runtime/helpers/objectSpread2';\nimport _classCallCheck from '@babel/runtime/helpers/classCallCheck';\nimport _createClass from '@babel/runtime/helpers/createClass';\nimport _callSuper from '@babel/runtime/helpers/callSuper';\nimport _inherits from '@babel/runtime/helpers/inherits';\nimport { ElementEvent, AABB, CustomEvent, CanvasEvent, Node, Shape, isPattern, GradientType, AbstractRendererPlugin } from '@antv/g-lite';\nimport _slicedToArray from '@babel/runtime/helpers/slicedToArray';\nimport _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';\nimport { isNil } from '@antv/util';\nimport { mat4, vec3 } from 'gl-matrix';\nimport _classPrivateFieldLooseBase from '@babel/runtime/helpers/classPrivateFieldLooseBase';\nimport _classPrivateFieldLooseKey from '@babel/runtime/helpers/classPrivateFieldLooseKey';\nimport { ImagePool } from '@antv/g-plugin-image-loader';\n\n/**\n * support 2 modes in rendering:\n * * immediate\n * * delayed: render at the end of frame with dirty-rectangle\n */\nvar CanvasRendererPlugin = /*#__PURE__*/function () {\n  /**\n   * RBush used in dirty rectangle rendering\n   */\n\n  function CanvasRendererPlugin(canvasRendererPluginOptions // private styleRendererFactory: Record<Shape, StyleRenderer>,\n  ) {\n    _classCallCheck(this, CanvasRendererPlugin);\n    this.removedRBushNodeAABBs = [];\n    this.renderQueue = [];\n    /**\n     * This stack is only used by clipPath for now.\n     */\n    this.restoreStack = [];\n    this.clearFullScreenLastFrame = false;\n    this.clearFullScreen = false;\n    /**\n     * view projection matrix\n     */\n    this.vpMatrix = mat4.create();\n    this.dprMatrix = mat4.create();\n    this.tmpMat4 = mat4.create();\n    this.vec3a = vec3.create();\n    this.vec3b = vec3.create();\n    this.vec3c = vec3.create();\n    this.vec3d = vec3.create();\n    this.canvasRendererPluginOptions = canvasRendererPluginOptions;\n  }\n  return _createClass(CanvasRendererPlugin, [{\n    key: \"apply\",\n    value: function apply(context, runtime) {\n      var _this = this;\n      this.context = context;\n      var config = context.config,\n        camera = context.camera,\n        renderingService = context.renderingService,\n        renderingContext = context.renderingContext,\n        rBushRoot = context.rBushRoot,\n        pathGeneratorFactory = context.pathGeneratorFactory;\n      this.rBush = rBushRoot;\n      this.pathGeneratorFactory = pathGeneratorFactory;\n      var contextService = context.contextService;\n      var canvas = renderingContext.root.ownerDocument.defaultView;\n      var handleUnmounted = function handleUnmounted(e) {\n        var object = e.target;\n\n        // remove r-bush node\n        // @ts-ignore\n        var rBushNode = object.rBushNode;\n        if (rBushNode.aabb) {\n          // save removed aabbs for dirty-rectangle rendering later\n          _this.removedRBushNodeAABBs.push(rBushNode.aabb);\n        }\n      };\n      var handleCulled = function handleCulled(e) {\n        var object = e.target;\n        // @ts-ignore\n        var rBushNode = object.rBushNode;\n        if (rBushNode.aabb) {\n          // save removed aabbs for dirty-rectangle rendering later\n          _this.removedRBushNodeAABBs.push(rBushNode.aabb);\n        }\n      };\n      renderingService.hooks.init.tap(CanvasRendererPlugin.tag, function () {\n        canvas.addEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n        canvas.addEventListener(ElementEvent.CULLED, handleCulled);\n\n        // clear fullscreen\n        var dpr = contextService.getDPR();\n        var width = config.width,\n          height = config.height;\n        var context = contextService.getContext();\n        _this.clearRect(context, 0, 0, width * dpr, height * dpr, config.background);\n      });\n      renderingService.hooks.destroy.tap(CanvasRendererPlugin.tag, function () {\n        canvas.removeEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n        canvas.removeEventListener(ElementEvent.CULLED, handleCulled);\n        _this.renderQueue = [];\n        _this.removedRBushNodeAABBs = [];\n        _this.restoreStack = [];\n      });\n      renderingService.hooks.beginFrame.tap(CanvasRendererPlugin.tag, function () {\n        var _canvas$context$rende;\n        var context = contextService.getContext();\n        var dpr = contextService.getDPR();\n        var width = config.width,\n          height = config.height;\n        var _this$canvasRendererP = _this.canvasRendererPluginOptions,\n          dirtyObjectNumThreshold = _this$canvasRendererP.dirtyObjectNumThreshold,\n          dirtyObjectRatioThreshold = _this$canvasRendererP.dirtyObjectRatioThreshold;\n\n        // some heuristic conditions such as 80% object changed\n        var _renderingService$get = renderingService.getStats(),\n          total = _renderingService$get.total,\n          rendered = _renderingService$get.rendered;\n        var ratio = rendered / total;\n        _this.clearFullScreen = _this.clearFullScreenLastFrame ||\n        // @ts-ignore\n        !((_canvas$context$rende = canvas.context.renderingPlugins[1]) !== null && _canvas$context$rende !== void 0 && _canvas$context$rende.isFirstTimeRenderingFinished) || renderingService.disableDirtyRectangleRendering() || rendered > dirtyObjectNumThreshold && ratio > dirtyObjectRatioThreshold;\n        if (context) {\n          context.resetTransform ? context.resetTransform() : context.setTransform(1, 0, 0, 1, 0, 0);\n          if (_this.clearFullScreen) {\n            _this.clearRect(context, 0, 0, width * dpr, height * dpr, config.background);\n          }\n        }\n      });\n      var _renderByZIndex = function renderByZIndex(object, context) {\n        if (object.isVisible() && !object.isCulled()) {\n          _this.renderDisplayObject(object, context, _this.context, _this.restoreStack, runtime);\n        }\n        var sorted = object.sortable.sorted || object.childNodes;\n\n        // should account for z-index\n        sorted.forEach(function (child) {\n          _renderByZIndex(child, context);\n        });\n      };\n\n      // render at the end of frame\n      renderingService.hooks.endFrame.tap(CanvasRendererPlugin.tag, function () {\n        // Skip rendering.\n        if (renderingContext.root.childNodes.length === 0) {\n          _this.clearFullScreenLastFrame = true;\n          return;\n        }\n        _this.clearFullScreenLastFrame = false;\n        var context = contextService.getContext();\n        // clear & clip dirty rectangle\n        var dpr = contextService.getDPR();\n        mat4.fromScaling(_this.dprMatrix, [dpr, dpr, 1]);\n        mat4.multiply(_this.vpMatrix, _this.dprMatrix, camera.getOrthoMatrix());\n        if (_this.clearFullScreen) {\n          // console.log('canvas renderer fcp...', renderingContext.root.childNodes);\n          _renderByZIndex(renderingContext.root, context);\n        } else {\n          // console.log('canvas renderer next...', this.renderQueue);\n          // merge removed AABB\n          var dirtyRenderBounds = _this.safeMergeAABB.apply(_this, [_this.mergeDirtyAABBs(_this.renderQueue)].concat(_toConsumableArray(_this.removedRBushNodeAABBs.map(function (_ref) {\n            var minX = _ref.minX,\n              minY = _ref.minY,\n              maxX = _ref.maxX,\n              maxY = _ref.maxY;\n            var aabb = new AABB();\n            aabb.setMinMax(\n            // vec3.fromValues(minX, minY, 0),\n            // vec3.fromValues(maxX, maxY, 0),\n            [minX, minY, 0], [maxX, maxY, 0]);\n            return aabb;\n          }))));\n          _this.removedRBushNodeAABBs = [];\n          if (AABB.isEmpty(dirtyRenderBounds)) {\n            _this.renderQueue = [];\n            return;\n          }\n          var dirtyRect = _this.convertAABB2Rect(dirtyRenderBounds);\n          var x = dirtyRect.x,\n            y = dirtyRect.y,\n            width = dirtyRect.width,\n            height = dirtyRect.height;\n          var tl = vec3.transformMat4(_this.vec3a, [x, y, 0], _this.vpMatrix);\n          var tr = vec3.transformMat4(_this.vec3b, [x + width, y, 0], _this.vpMatrix);\n          var bl = vec3.transformMat4(_this.vec3c, [x, y + height, 0], _this.vpMatrix);\n          var br = vec3.transformMat4(_this.vec3d, [x + width, y + height, 0], _this.vpMatrix);\n          var minx = Math.min(tl[0], tr[0], br[0], bl[0]);\n          var miny = Math.min(tl[1], tr[1], br[1], bl[1]);\n          var maxx = Math.max(tl[0], tr[0], br[0], bl[0]);\n          var maxy = Math.max(tl[1], tr[1], br[1], bl[1]);\n          var ix = Math.floor(minx);\n          var iy = Math.floor(miny);\n          var iwidth = Math.ceil(maxx - minx);\n          var iheight = Math.ceil(maxy - miny);\n          context.save();\n          _this.clearRect(context, ix, iy, iwidth, iheight, config.background);\n          context.beginPath();\n          context.rect(ix, iy, iwidth, iheight);\n          context.clip();\n\n          // @see https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Transformations\n          context.setTransform(_this.vpMatrix[0], _this.vpMatrix[1], _this.vpMatrix[4], _this.vpMatrix[5], _this.vpMatrix[12], _this.vpMatrix[13]);\n\n          // draw dirty rectangle\n          var _config$renderer$getC = config.renderer.getConfig(),\n            enableDirtyRectangleRenderingDebug = _config$renderer$getC.enableDirtyRectangleRenderingDebug;\n          if (enableDirtyRectangleRenderingDebug) {\n            canvas.dispatchEvent(new CustomEvent(CanvasEvent.DIRTY_RECTANGLE, {\n              dirtyRect: {\n                x: ix,\n                y: iy,\n                width: iwidth,\n                height: iheight\n              }\n            }));\n          }\n\n          // search objects intersect with dirty rectangle\n          var dirtyObjects = _this.searchDirtyObjects(dirtyRenderBounds);\n\n          // do rendering\n          dirtyObjects\n          // sort by z-index\n          .sort(function (a, b) {\n            return a.sortable.renderOrder - b.sortable.renderOrder;\n          }).forEach(function (object) {\n            // culled object should not be rendered\n            if (object && object.isVisible() && !object.isCulled()) {\n              _this.renderDisplayObject(object, context, _this.context, _this.restoreStack, runtime);\n            }\n          });\n          context.restore();\n\n          // save dirty AABBs in last frame\n          _this.renderQueue.forEach(function (object) {\n            _this.saveDirtyAABB(object);\n          });\n\n          // clear queue\n          _this.renderQueue = [];\n        }\n\n        // pop restore stack, eg. root -> parent -> child\n        _this.restoreStack.forEach(function () {\n          context.restore();\n        });\n        // clear restore stack\n        _this.restoreStack = [];\n      });\n      renderingService.hooks.render.tap(CanvasRendererPlugin.tag, function (object) {\n        if (!_this.clearFullScreen) {\n          // render at the end of frame\n          _this.renderQueue.push(object);\n        }\n      });\n    }\n  }, {\n    key: \"clearRect\",\n    value: function clearRect(context, x, y, width, height, background) {\n      // clearRect is faster than fillRect @see https://stackoverflow.com/a/30830253\n      context.clearRect(x, y, width, height);\n      if (background) {\n        context.fillStyle = background;\n        context.fillRect(x, y, width, height);\n      }\n    }\n  }, {\n    key: \"renderDisplayObject\",\n    value: function renderDisplayObject(object, context, canvasContext, restoreStack, runtime) {\n      var nodeName = object.nodeName;\n\n      // console.log('canvas render:', object);\n\n      // restore to its ancestor\n\n      var parent = restoreStack[restoreStack.length - 1];\n      if (parent && !(object.compareDocumentPosition(parent) & Node.DOCUMENT_POSITION_CONTAINS)) {\n        context.restore();\n        restoreStack.pop();\n      }\n\n      // @ts-ignore\n      var styleRenderer = this.context.styleRendererFactory[nodeName];\n      var generatePath = this.pathGeneratorFactory[nodeName];\n\n      // clip path\n      var _ref2 = object.parsedStyle,\n        clipPath = _ref2.clipPath;\n      if (clipPath) {\n        this.applyWorldTransform(context, clipPath);\n\n        // generate path in local space\n        var _generatePath = this.pathGeneratorFactory[clipPath.nodeName];\n        if (_generatePath) {\n          context.save();\n\n          // save clip\n          restoreStack.push(object);\n          context.beginPath();\n          _generatePath(context, clipPath.parsedStyle);\n          context.closePath();\n          context.clip();\n        }\n      }\n\n      // fill & stroke\n\n      if (styleRenderer) {\n        this.applyWorldTransform(context, object);\n        context.save();\n\n        // apply attributes to context\n        this.applyAttributesToContext(context, object);\n      }\n      if (generatePath) {\n        context.beginPath();\n        generatePath(context, object.parsedStyle);\n        if (object.nodeName !== Shape.LINE && object.nodeName !== Shape.PATH && object.nodeName !== Shape.POLYLINE) {\n          context.closePath();\n        }\n      }\n\n      // fill & stroke\n      if (styleRenderer) {\n        styleRenderer.render(context, object.parsedStyle, object, canvasContext, this, runtime);\n\n        // restore applied attributes, eg. shadowBlur shadowColor...\n        context.restore();\n      }\n\n      // finish rendering, clear dirty flag\n      object.renderable.dirty = false;\n    }\n  }, {\n    key: \"convertAABB2Rect\",\n    value: function convertAABB2Rect(aabb) {\n      var min = aabb.getMin();\n      var max = aabb.getMax();\n      // expand the rectangle a bit to avoid artifacts\n      // @see https://www.yuque.com/antv/ou292n/bi8nix#ExvCu\n      var minX = Math.floor(min[0]);\n      var minY = Math.floor(min[1]);\n      var maxX = Math.ceil(max[0]);\n      var maxY = Math.ceil(max[1]);\n      var width = maxX - minX;\n      var height = maxY - minY;\n      return {\n        x: minX,\n        y: minY,\n        width: width,\n        height: height\n      };\n    }\n\n    /**\n     * TODO: merge dirty rectangles with some strategies.\n     * For now, we just simply merge all the rectangles into one.\n     * @see https://idom.me/articles/841.html\n     */\n  }, {\n    key: \"mergeDirtyAABBs\",\n    value: function mergeDirtyAABBs(dirtyObjects) {\n      // merge into a big AABB\n      // TODO: skip descendant if ancestor is caculated, but compareNodePosition is really slow\n      var aabb = new AABB();\n      dirtyObjects.forEach(function (object) {\n        var renderBounds = object.getRenderBounds();\n        aabb.add(renderBounds);\n        var dirtyRenderBounds = object.renderable.dirtyRenderBounds;\n        if (dirtyRenderBounds) {\n          aabb.add(dirtyRenderBounds);\n        }\n      });\n      return aabb;\n    }\n  }, {\n    key: \"searchDirtyObjects\",\n    value: function searchDirtyObjects(dirtyRectangle) {\n      // search in r-tree, get all affected nodes\n      var _dirtyRectangle$getMi = dirtyRectangle.getMin(),\n        _dirtyRectangle$getMi2 = _slicedToArray(_dirtyRectangle$getMi, 2),\n        minX = _dirtyRectangle$getMi2[0],\n        minY = _dirtyRectangle$getMi2[1];\n      var _dirtyRectangle$getMa = dirtyRectangle.getMax(),\n        _dirtyRectangle$getMa2 = _slicedToArray(_dirtyRectangle$getMa, 2),\n        maxX = _dirtyRectangle$getMa2[0],\n        maxY = _dirtyRectangle$getMa2[1];\n      var rBushNodes = this.rBush.search({\n        minX: minX,\n        minY: minY,\n        maxX: maxX,\n        maxY: maxY\n      });\n      return rBushNodes.map(function (_ref3) {\n        var displayObject = _ref3.displayObject;\n        return displayObject;\n      });\n    }\n  }, {\n    key: \"saveDirtyAABB\",\n    value: function saveDirtyAABB(object) {\n      var renderable = object.renderable;\n      if (!renderable.dirtyRenderBounds) {\n        renderable.dirtyRenderBounds = new AABB();\n      }\n      var renderBounds = object.getRenderBounds();\n      if (renderBounds) {\n        // save last dirty aabb\n        renderable.dirtyRenderBounds.update(renderBounds.center, renderBounds.halfExtents);\n      }\n    }\n\n    /**\n     * TODO: batch the same global attributes\n     */\n  }, {\n    key: \"applyAttributesToContext\",\n    value: function applyAttributesToContext(context, object) {\n      var _ref4 = object.parsedStyle,\n        stroke = _ref4.stroke,\n        fill = _ref4.fill,\n        opacity = _ref4.opacity,\n        lineDash = _ref4.lineDash,\n        lineDashOffset = _ref4.lineDashOffset;\n      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/setLineDash\n      if (lineDash) {\n        context.setLineDash(lineDash);\n      }\n\n      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineDashOffset\n      if (!isNil(lineDashOffset)) {\n        context.lineDashOffset = lineDashOffset;\n      }\n      if (!isNil(opacity)) {\n        context.globalAlpha *= opacity;\n      }\n      if (!isNil(stroke) && !Array.isArray(stroke) && !stroke.isNone) {\n        context.strokeStyle = object.attributes.stroke;\n      }\n      if (!isNil(fill) && !Array.isArray(fill) && !fill.isNone) {\n        context.fillStyle = object.attributes.fill;\n      }\n    }\n  }, {\n    key: \"applyWorldTransform\",\n    value: function applyWorldTransform(context, object, matrix) {\n      // apply clip shape's RTS\n      if (matrix) {\n        mat4.copy(this.tmpMat4, object.getLocalTransform());\n        mat4.multiply(this.tmpMat4, matrix, this.tmpMat4);\n        mat4.multiply(this.tmpMat4, this.vpMatrix, this.tmpMat4);\n      } else {\n        // apply RTS transformation in world space\n        mat4.copy(this.tmpMat4, object.getWorldTransform());\n        mat4.multiply(this.tmpMat4, this.vpMatrix, this.tmpMat4);\n      }\n\n      // @see https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Transformations\n      context.setTransform(this.tmpMat4[0], this.tmpMat4[1], this.tmpMat4[4], this.tmpMat4[5], this.tmpMat4[12], this.tmpMat4[13]);\n    }\n  }, {\n    key: \"safeMergeAABB\",\n    value: function safeMergeAABB() {\n      var merged = new AABB();\n      for (var _len = arguments.length, aabbs = new Array(_len), _key = 0; _key < _len; _key++) {\n        aabbs[_key] = arguments[_key];\n      }\n      aabbs.forEach(function (aabb) {\n        merged.add(aabb);\n      });\n      return merged;\n    }\n  }]);\n}();\nCanvasRendererPlugin.tag = 'CanvasRenderer';\nvar DefaultRenderer = /*#__PURE__*/function () {\n  function DefaultRenderer(imagePool) {\n    _classCallCheck(this, DefaultRenderer);\n    this.imagePool = imagePool;\n  }\n  return _createClass(DefaultRenderer, [{\n    key: \"render\",\n    value: function render(context, parsedStyle, object, canvasContext, plugin, runtime) {\n      var fill = parsedStyle.fill,\n        fillRule = parsedStyle.fillRule,\n        _parsedStyle$opacity = parsedStyle.opacity,\n        opacity = _parsedStyle$opacity === void 0 ? 1 : _parsedStyle$opacity,\n        _parsedStyle$fillOpac = parsedStyle.fillOpacity,\n        fillOpacity = _parsedStyle$fillOpac === void 0 ? 1 : _parsedStyle$fillOpac,\n        stroke = parsedStyle.stroke,\n        _parsedStyle$strokeOp = parsedStyle.strokeOpacity,\n        strokeOpacity = _parsedStyle$strokeOp === void 0 ? 1 : _parsedStyle$strokeOp,\n        _parsedStyle$lineWidt = parsedStyle.lineWidth,\n        lineWidth = _parsedStyle$lineWidt === void 0 ? 1 : _parsedStyle$lineWidt,\n        lineCap = parsedStyle.lineCap,\n        lineJoin = parsedStyle.lineJoin,\n        shadowType = parsedStyle.shadowType,\n        shadowColor = parsedStyle.shadowColor,\n        shadowBlur = parsedStyle.shadowBlur,\n        filter = parsedStyle.filter,\n        miterLimit = parsedStyle.miterLimit;\n      var hasFill = fill && !fill.isNone;\n      var hasStroke = stroke && !stroke.isNone && lineWidth > 0;\n      var isFillTransparent = (fill === null || fill === void 0 ? void 0 : fill.alpha) === 0;\n      var hasFilter = !!(filter && filter.length);\n      var hasShadow = !isNil(shadowColor) && shadowBlur > 0;\n      var nodeName = object.nodeName;\n      var isInnerShadow = shadowType === 'inner';\n      var shouldDrawShadowWithStroke = hasStroke && hasShadow && (nodeName === Shape.PATH || nodeName === Shape.LINE || nodeName === Shape.POLYLINE || isFillTransparent || isInnerShadow);\n      if (hasFill) {\n        context.globalAlpha = opacity * fillOpacity;\n        if (!shouldDrawShadowWithStroke) {\n          setShadowAndFilter(object, context, hasShadow);\n        }\n        applyFill(context, object, fill, fillRule, canvasContext, plugin, runtime, this.imagePool);\n        if (!shouldDrawShadowWithStroke) {\n          this.clearShadowAndFilter(context, hasFilter, hasShadow);\n        }\n      }\n      if (hasStroke) {\n        context.globalAlpha = opacity * strokeOpacity;\n        context.lineWidth = lineWidth;\n        if (!isNil(miterLimit)) {\n          context.miterLimit = miterLimit;\n        }\n        if (!isNil(lineCap)) {\n          context.lineCap = lineCap;\n        }\n        if (!isNil(lineJoin)) {\n          context.lineJoin = lineJoin;\n        }\n        if (shouldDrawShadowWithStroke) {\n          if (isInnerShadow) {\n            context.globalCompositeOperation = 'source-atop';\n          }\n          setShadowAndFilter(object, context, true);\n          if (isInnerShadow) {\n            applyStroke(context, object, stroke, canvasContext, plugin, runtime, this.imagePool);\n            context.globalCompositeOperation = 'source-over';\n            this.clearShadowAndFilter(context, hasFilter, true);\n          }\n        }\n        applyStroke(context, object, stroke, canvasContext, plugin, runtime, this.imagePool);\n      }\n    }\n  }, {\n    key: \"clearShadowAndFilter\",\n    value: function clearShadowAndFilter(context, hasFilter, hasShadow) {\n      if (hasShadow) {\n        context.shadowColor = 'transparent';\n        context.shadowBlur = 0;\n      }\n      if (hasFilter) {\n        // save drop-shadow filter\n        var oldFilter = context.filter;\n        if (!isNil(oldFilter) && oldFilter.indexOf('drop-shadow') > -1) {\n          context.filter = oldFilter.replace(/drop-shadow\\([^)]*\\)/, '').trim() || 'none';\n        }\n      }\n    }\n  }]);\n}();\n\n/**\n * apply before fill and stroke but only once\n */\nfunction setShadowAndFilter(object, context, hasShadow) {\n  var _ref = object.parsedStyle,\n    filter = _ref.filter,\n    shadowColor = _ref.shadowColor,\n    shadowBlur = _ref.shadowBlur,\n    shadowOffsetX = _ref.shadowOffsetX,\n    shadowOffsetY = _ref.shadowOffsetY;\n  if (filter && filter.length) {\n    // use raw filter string\n    context.filter = object.style.filter;\n  }\n  if (hasShadow) {\n    context.shadowColor = shadowColor.toString();\n    context.shadowBlur = shadowBlur || 0;\n    context.shadowOffsetX = shadowOffsetX || 0;\n    context.shadowOffsetY = shadowOffsetY || 0;\n  }\n}\nfunction getPattern(pattern, object, context, canvasContext, plugin, runtime, imagePool) {\n  var $offscreenCanvas;\n  var dpr;\n  if (pattern.image.nodeName === 'rect') {\n    var _parsedStyle = pattern.image.parsedStyle,\n      width = _parsedStyle.width,\n      height = _parsedStyle.height;\n    dpr = canvasContext.contextService.getDPR();\n    var offscreenCanvas = canvasContext.config.offscreenCanvas;\n    $offscreenCanvas = runtime.offscreenCanvasCreator.getOrCreateCanvas(offscreenCanvas);\n    $offscreenCanvas.width = width * dpr;\n    $offscreenCanvas.height = height * dpr;\n    var offscreenCanvasContext = runtime.offscreenCanvasCreator.getOrCreateContext(offscreenCanvas);\n    var restoreStack = [];\n\n    // offscreenCanvasContext.scale(1 / dpr, 1 / dpr);\n\n    pattern.image.forEach(function (object) {\n      plugin.renderDisplayObject(object, offscreenCanvasContext, canvasContext, restoreStack, runtime);\n    });\n    restoreStack.forEach(function () {\n      offscreenCanvasContext.restore();\n    });\n  }\n  var canvasPattern = imagePool.getOrCreatePatternSync(object, pattern, context, $offscreenCanvas, dpr, object.getGeometryBounds().min, function () {\n    // set dirty rectangle flag\n    object.renderable.dirty = true;\n    canvasContext.renderingService.dirtify();\n  });\n  return canvasPattern;\n}\nfunction getColor(parsedColor, object, context, imagePool) {\n  var color;\n  if (parsedColor.type === GradientType.LinearGradient || parsedColor.type === GradientType.RadialGradient) {\n    var bounds = object.getGeometryBounds();\n    var width = bounds && bounds.halfExtents[0] * 2 || 1;\n    var height = bounds && bounds.halfExtents[1] * 2 || 1;\n    var min = bounds && bounds.min || [0, 0];\n    color = imagePool.getOrCreateGradient(_objectSpread(_objectSpread({\n      type: parsedColor.type\n    }, parsedColor.value), {}, {\n      min: min,\n      width: width,\n      height: height\n    }), context);\n  }\n  return color;\n}\nfunction applyFill(context, object, fill, fillRule, canvasContext, plugin, runtime, imagePool) {\n  var skipFill = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : false;\n  if (Array.isArray(fill)) {\n    fill.forEach(function (gradient) {\n      context.fillStyle = getColor(gradient, object, context, imagePool);\n      if (!skipFill) {\n        fillRule ? context.fill(fillRule) : context.fill();\n      }\n    });\n  } else {\n    if (isPattern(fill)) {\n      context.fillStyle = getPattern(fill, object, context, canvasContext, plugin, runtime, imagePool);\n    }\n    if (!skipFill) {\n      fillRule ? context.fill(fillRule) : context.fill();\n    }\n  }\n}\nfunction applyStroke(context, object, stroke, canvasContext, plugin, runtime, imagePool) {\n  var skipStroke = arguments.length > 7 && arguments[7] !== undefined ? arguments[7] : false;\n  if (Array.isArray(stroke)) {\n    stroke.forEach(function (gradient) {\n      context.strokeStyle = getColor(gradient, object, context, imagePool);\n      if (!skipStroke) {\n        context.stroke();\n      }\n    });\n  } else {\n    if (isPattern(stroke)) {\n      context.strokeStyle = getPattern(stroke, object, context, canvasContext, plugin, runtime, imagePool);\n    }\n    if (!skipStroke) {\n      context.stroke();\n    }\n  }\n}\nfunction calculateOverlapRect(rect1, rect2) {\n  var _rect = _slicedToArray(rect1, 4),\n    x1 = _rect[0],\n    y1 = _rect[1],\n    w1 = _rect[2],\n    h1 = _rect[3];\n  var _rect2 = _slicedToArray(rect2, 4),\n    x2 = _rect2[0],\n    y2 = _rect2[1],\n    w2 = _rect2[2],\n    h2 = _rect2[3];\n\n  // 计算重叠区域的左上角和右下角\n  var overlapLeft = Math.max(x1, x2);\n  var overlapTop = Math.max(y1, y2);\n  var overlapRight = Math.min(x1 + w1, x2 + w2);\n  var overlapBottom = Math.min(y1 + h1, y2 + h2);\n  if (overlapRight <= overlapLeft || overlapBottom <= overlapTop) {\n    return null;\n  }\n  return [overlapLeft, overlapTop, overlapRight - overlapLeft, overlapBottom - overlapTop];\n}\nfunction transformRect(rect, matrix) {\n  var tl = vec3.transformMat4(vec3.create(), [rect[0], rect[1], 0], matrix);\n  var tr = vec3.transformMat4(vec3.create(), [rect[0] + rect[2], rect[1], 0], matrix);\n  var bl = vec3.transformMat4(vec3.create(), [rect[0], rect[1] + rect[3], 0], matrix);\n  var br = vec3.transformMat4(vec3.create(), [rect[0] + rect[2], rect[1] + rect[3], 0], matrix);\n  return [Math.min(tl[0], tr[0], bl[0], br[0]), Math.min(tl[1], tr[1], bl[1], br[1]), Math.max(tl[0], tr[0], bl[0], br[0]) - Math.min(tl[0], tr[0], bl[0], br[0]), Math.max(tl[1], tr[1], bl[1], br[1]) - Math.min(tl[1], tr[1], bl[1], br[1])];\n}\nvar _renderDownSampled = /*#__PURE__*/_classPrivateFieldLooseKey(\"renderDownSampled\");\nvar _renderTile = /*#__PURE__*/_classPrivateFieldLooseKey(\"renderTile\");\nvar ImageRenderer = /*#__PURE__*/function () {\n  function ImageRenderer(imagePool) {\n    _classCallCheck(this, ImageRenderer);\n    Object.defineProperty(this, _renderTile, {\n      value: _renderTile2\n    });\n    Object.defineProperty(this, _renderDownSampled, {\n      value: _renderDownSampled2\n    });\n    this.imagePool = imagePool;\n  }\n  return _createClass(ImageRenderer, [{\n    key: \"render\",\n    value: function render(context, parsedStyle, object) {\n      var _parsedStyle$x = parsedStyle.x,\n        x = _parsedStyle$x === void 0 ? 0 : _parsedStyle$x,\n        _parsedStyle$y = parsedStyle.y,\n        y = _parsedStyle$y === void 0 ? 0 : _parsedStyle$y,\n        width = parsedStyle.width,\n        height = parsedStyle.height,\n        src = parsedStyle.src,\n        shadowColor = parsedStyle.shadowColor,\n        shadowBlur = parsedStyle.shadowBlur;\n      var imageCache = this.imagePool.getImageSync(src, object);\n      var image = imageCache === null || imageCache === void 0 ? void 0 : imageCache.img;\n      var iw = width;\n      var ih = height;\n      if (!image) {\n        return;\n      }\n      iw || (iw = image.width);\n      ih || (ih = image.height);\n      var hasShadow = !isNil(shadowColor) && shadowBlur > 0;\n      setShadowAndFilter(object, context, hasShadow);\n\n      // node-canvas will throw the following err:\n      // Error: Image given has not completed loading\n      try {\n        var _object$ownerDocument = object.ownerDocument.defaultView.getContextService().getDomElement(),\n          viewWidth = _object$ownerDocument.width,\n          viewHeight = _object$ownerDocument.height;\n        var currentTransform = context.getTransform();\n        var a = currentTransform.a,\n          b = currentTransform.b,\n          c = currentTransform.c,\n          d = currentTransform.d,\n          e = currentTransform.e,\n          f = currentTransform.f;\n        // 构建 mat4 矩阵\n        // prettier-ignore\n        var transformMatrix = mat4.fromValues(a, c, 0, 0, b, d, 0, 0, 0, 0, 1, 0, e, f, 0, 1);\n        var imageRect = transformRect([x, y, iw, ih], transformMatrix);\n        var drawRect = calculateOverlapRect([0, 0, viewWidth, viewHeight], imageRect);\n        if (!drawRect) {\n          return;\n        }\n        if (!object.ownerDocument.defaultView.getConfig().enableLargeImageOptimization) {\n          ImageRenderer.renderFull(context, parsedStyle, object, {\n            image: image,\n            drawRect: [x, y, iw, ih]\n          });\n          return;\n        }\n        var sizeOfOrigin = imageRect[2] / imageCache.size[0];\n        if (sizeOfOrigin < (imageCache.downSamplingRate || 0.5)) {\n          _classPrivateFieldLooseBase(this, _renderDownSampled)[_renderDownSampled](context, parsedStyle, object, {\n            src: src,\n            imageCache: imageCache,\n            drawRect: [x, y, iw, ih]\n          });\n          return;\n        }\n        if (!ImagePool.isSupportTile) {\n          ImageRenderer.renderFull(context, parsedStyle, object, {\n            image: image,\n            drawRect: [x, y, iw, ih]\n          });\n          return;\n        }\n        _classPrivateFieldLooseBase(this, _renderTile)[_renderTile](context, parsedStyle, object, {\n          src: src,\n          imageCache: imageCache,\n          imageRect: imageRect,\n          drawRect: drawRect\n        });\n      } catch (_unused) {}\n    }\n  }], [{\n    key: \"renderFull\",\n    value: function renderFull(context, parsedStyle, object, data) {\n      context.drawImage(data.image, Math.floor(data.drawRect[0]), Math.floor(data.drawRect[1]), Math.ceil(data.drawRect[2]), Math.ceil(data.drawRect[3]));\n    }\n  }]);\n}();\nfunction _renderDownSampled2(context, parsedStyle, object, data) {\n  var src = data.src,\n    imageCache = data.imageCache;\n  if (!imageCache.downSampled) {\n    this.imagePool.createDownSampledImage(src, object).then(function (res) {\n      // rerender\n      object.renderable.dirty = true;\n      object.ownerDocument.defaultView.context.renderingService.dirtify();\n    })[\"catch\"](function () {\n      //\n    });\n    return;\n  }\n  context.drawImage(imageCache.downSampled, Math.floor(data.drawRect[0]), Math.floor(data.drawRect[1]), Math.ceil(data.drawRect[2]), Math.ceil(data.drawRect[3]));\n}\nfunction _renderTile2(context, parsedStyle, object, data) {\n  var src = data.src,\n    imageCache = data.imageCache,\n    imageRect = data.imageRect,\n    drawRect = data.drawRect;\n  var originalSize = imageCache.size;\n  var _context$getTransform = context.getTransform(),\n    a = _context$getTransform.a,\n    b = _context$getTransform.b,\n    c = _context$getTransform.c,\n    d = _context$getTransform.d,\n    e = _context$getTransform.e,\n    f = _context$getTransform.f;\n  context.resetTransform();\n  if (!(imageCache !== null && imageCache !== void 0 && imageCache.gridSize)) {\n    this.imagePool.createImageTiles(src, [], object).then(function () {\n      // rerender\n      object.renderable.dirty = true;\n      object.ownerDocument.defaultView.context.renderingService.dirtify();\n    })[\"catch\"](function () {\n      //\n    });\n    return;\n  }\n  var scaleToOrigin = [originalSize[0] / imageRect[2], originalSize[1] / imageRect[3]];\n  var scaledTileSize = [imageCache.tileSize[0] / scaleToOrigin[0], imageCache.tileSize[1] / scaleToOrigin[1]];\n  var _ref = [Math.floor((drawRect[0] - imageRect[0]) / scaledTileSize[0]), Math.ceil((drawRect[0] + drawRect[2] - imageRect[0]) / scaledTileSize[0])],\n    startTileX = _ref[0],\n    endTileX = _ref[1];\n  var _ref2 = [Math.floor((drawRect[1] - imageRect[1]) / scaledTileSize[1]), Math.ceil((drawRect[1] + drawRect[3] - imageRect[1]) / scaledTileSize[1])],\n    startTileY = _ref2[0],\n    endTileY = _ref2[1];\n  for (var tileY = startTileY; tileY <= endTileY; tileY++) {\n    for (var tileX = startTileX; tileX <= endTileX; tileX++) {\n      var item = imageCache.tiles[tileY][tileX];\n      if (item) {\n        var tileRect = [Math.floor(imageRect[0] + item.tileX * scaledTileSize[0]), Math.floor(imageRect[1] + item.tileY * scaledTileSize[1]), Math.ceil(scaledTileSize[0]), Math.ceil(scaledTileSize[1])];\n        context.drawImage(item.data, tileRect[0], tileRect[1], tileRect[2], tileRect[3]);\n      }\n    }\n  }\n  context.setTransform(a, b, c, d, e, f);\n}\nvar TextRenderer = /*#__PURE__*/function () {\n  function TextRenderer(imagePool) {\n    _classCallCheck(this, TextRenderer);\n    this.imagePool = imagePool;\n  }\n  return _createClass(TextRenderer, [{\n    key: \"render\",\n    value: function render(context, parsedStyle, object, canvasContext, plugin, runtime) {\n      // Trigger text geometry calculation.\n      object.getBounds();\n      var _parsedStyle$lineWidt = parsedStyle.lineWidth,\n        lineWidth = _parsedStyle$lineWidt === void 0 ? 1 : _parsedStyle$lineWidt,\n        _parsedStyle$textAlig = parsedStyle.textAlign,\n        textAlign = _parsedStyle$textAlig === void 0 ? 'start' : _parsedStyle$textAlig,\n        _parsedStyle$textBase = parsedStyle.textBaseline,\n        textBaseline = _parsedStyle$textBase === void 0 ? 'alphabetic' : _parsedStyle$textBase,\n        _parsedStyle$lineJoin = parsedStyle.lineJoin,\n        lineJoin = _parsedStyle$lineJoin === void 0 ? 'miter' : _parsedStyle$lineJoin,\n        _parsedStyle$miterLim = parsedStyle.miterLimit,\n        miterLimit = _parsedStyle$miterLim === void 0 ? 10 : _parsedStyle$miterLim,\n        _parsedStyle$letterSp = parsedStyle.letterSpacing,\n        letterSpacing = _parsedStyle$letterSp === void 0 ? 0 : _parsedStyle$letterSp,\n        stroke = parsedStyle.stroke,\n        fill = parsedStyle.fill,\n        fillRule = parsedStyle.fillRule,\n        _parsedStyle$fillOpac = parsedStyle.fillOpacity,\n        fillOpacity = _parsedStyle$fillOpac === void 0 ? 1 : _parsedStyle$fillOpac,\n        _parsedStyle$strokeOp = parsedStyle.strokeOpacity,\n        strokeOpacity = _parsedStyle$strokeOp === void 0 ? 1 : _parsedStyle$strokeOp,\n        _parsedStyle$opacity = parsedStyle.opacity,\n        opacity = _parsedStyle$opacity === void 0 ? 1 : _parsedStyle$opacity,\n        metrics = parsedStyle.metrics,\n        _parsedStyle$x = parsedStyle.x,\n        x = _parsedStyle$x === void 0 ? 0 : _parsedStyle$x,\n        _parsedStyle$y = parsedStyle.y,\n        y = _parsedStyle$y === void 0 ? 0 : _parsedStyle$y,\n        dx = parsedStyle.dx,\n        dy = parsedStyle.dy,\n        shadowColor = parsedStyle.shadowColor,\n        shadowBlur = parsedStyle.shadowBlur;\n      var font = metrics.font,\n        lines = metrics.lines,\n        height = metrics.height,\n        lineHeight = metrics.lineHeight,\n        lineMetrics = metrics.lineMetrics;\n      context.font = font;\n      context.lineWidth = lineWidth;\n      context.textAlign = textAlign === 'middle' ? 'center' : textAlign;\n      var formattedTextBaseline = textBaseline;\n      if (formattedTextBaseline === 'alphabetic') {\n        formattedTextBaseline = 'bottom';\n      }\n      context.lineJoin = lineJoin;\n      if (!isNil(miterLimit)) {\n        context.miterLimit = miterLimit;\n      }\n      var linePositionY = y;\n      // handle vertical text baseline\n      if (textBaseline === 'middle') {\n        linePositionY += -height / 2 - lineHeight / 2;\n      } else if (textBaseline === 'bottom' || textBaseline === 'alphabetic' || textBaseline === 'ideographic') {\n        linePositionY += -height;\n      } else if (textBaseline === 'top' || textBaseline === 'hanging') {\n        linePositionY += -lineHeight;\n      }\n\n      // account for dx & dy\n      var offsetX = x + (dx || 0);\n      linePositionY += dy || 0;\n      if (lines.length === 1) {\n        if (formattedTextBaseline === 'bottom') {\n          formattedTextBaseline = 'middle';\n          linePositionY -= 0.5 * height;\n        } else if (formattedTextBaseline === 'top') {\n          formattedTextBaseline = 'middle';\n          linePositionY += 0.5 * height;\n        }\n      }\n      context.textBaseline = formattedTextBaseline;\n      var hasShadow = !isNil(shadowColor) && shadowBlur > 0;\n      setShadowAndFilter(object, context, hasShadow);\n\n      // draw lines line by line\n      for (var i = 0; i < lines.length; i++) {\n        var linePositionX = lineWidth / 2 + offsetX;\n        linePositionY += lineHeight;\n\n        // no need to re-position X, cause we already set text align\n        // @see https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/textAlign\n        if (!isNil(stroke) && !stroke.isNone && lineWidth) {\n          this.drawLetterSpacing(context, object, lines[i], lineMetrics[i], textAlign, linePositionX, linePositionY, letterSpacing, fill, fillRule, fillOpacity, stroke, strokeOpacity, opacity, true, canvasContext, plugin, runtime);\n        }\n        if (!isNil(fill)) {\n          this.drawLetterSpacing(context, object, lines[i], lineMetrics[i], textAlign, linePositionX, linePositionY, letterSpacing, fill, fillRule, fillOpacity, stroke, strokeOpacity, opacity, false, canvasContext, plugin, runtime);\n        }\n      }\n    }\n  }, {\n    key: \"drawLetterSpacing\",\n    value: function drawLetterSpacing(context, object, text, lineMetrics, textAlign, x, y, letterSpacing, fill, fillRule, fillOpacity, stroke, strokeOpacity, opacity, isStroke, canvasContext, plugin, runtime) {\n      // letterSpacing of 0 means normal, render all texts directly\n      if (letterSpacing === 0) {\n        if (isStroke) {\n          this.strokeText(context, object, text, x, y, stroke, strokeOpacity, canvasContext, plugin, runtime);\n        } else {\n          this.fillText(context, object, text, x, y, fill, fillRule, fillOpacity, opacity, canvasContext, plugin, runtime);\n        }\n        return;\n      }\n\n      // draw text using left align\n      var currentTextAlign = context.textAlign;\n      context.textAlign = 'left';\n      var currentPosition = x;\n      if (textAlign === 'center' || textAlign === 'middle') {\n        currentPosition = x - lineMetrics.width / 2;\n      } else if (textAlign === 'right' || textAlign === 'end') {\n        currentPosition = x - lineMetrics.width;\n      }\n      var stringArray = Array.from(text);\n      var previousWidth = context.measureText(text).width;\n      var currentWidth = 0;\n      for (var i = 0; i < stringArray.length; ++i) {\n        var currentChar = stringArray[i];\n        if (isStroke) {\n          this.strokeText(context, object, currentChar, currentPosition, y, stroke, strokeOpacity, canvasContext, plugin, runtime);\n        } else {\n          this.fillText(context, object, currentChar, currentPosition, y, fill, fillRule, fillOpacity, opacity, canvasContext, plugin, runtime);\n        }\n        currentWidth = context.measureText(text.substring(i + 1)).width;\n        currentPosition += previousWidth - currentWidth + letterSpacing;\n        previousWidth = currentWidth;\n      }\n      context.textAlign = currentTextAlign;\n    }\n  }, {\n    key: \"fillText\",\n    value: function fillText(context, object, text, x, y, fill, fillRule, fillOpacity, opacity, canvasContext, plugin, runtime) {\n      applyFill(context, object, fill, fillRule, canvasContext, plugin, runtime, this.imagePool, true);\n      var currentGlobalAlpha;\n      var applyOpacity = !isNil(fillOpacity) && fillOpacity !== 1;\n      if (applyOpacity) {\n        currentGlobalAlpha = context.globalAlpha;\n        context.globalAlpha = fillOpacity * opacity;\n      }\n      context.fillText(text, x, y);\n      if (applyOpacity) {\n        context.globalAlpha = currentGlobalAlpha;\n      }\n    }\n  }, {\n    key: \"strokeText\",\n    value: function strokeText(context, object, text, x, y, stroke, strokeOpacity, canvasContext, plugin, runtime) {\n      applyStroke(context, object, stroke, canvasContext, plugin, runtime, this.imagePool, true);\n      var currentGlobalAlpha;\n      var applyOpacity = !isNil(strokeOpacity) && strokeOpacity !== 1;\n      if (applyOpacity) {\n        currentGlobalAlpha = context.globalAlpha;\n        context.globalAlpha = strokeOpacity;\n      }\n      context.strokeText(text, x, y);\n      if (applyOpacity) {\n        context.globalAlpha = currentGlobalAlpha;\n      }\n    }\n  }]);\n}();\nvar RectRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function RectRenderer() {\n    _classCallCheck(this, RectRenderer);\n    return _callSuper(this, RectRenderer, arguments);\n  }\n  _inherits(RectRenderer, _DefaultRenderer);\n  return _createClass(RectRenderer);\n}(DefaultRenderer);\nvar CircleRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function CircleRenderer() {\n    _classCallCheck(this, CircleRenderer);\n    return _callSuper(this, CircleRenderer, arguments);\n  }\n  _inherits(CircleRenderer, _DefaultRenderer);\n  return _createClass(CircleRenderer);\n}(DefaultRenderer);\nvar EllipseRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function EllipseRenderer() {\n    _classCallCheck(this, EllipseRenderer);\n    return _callSuper(this, EllipseRenderer, arguments);\n  }\n  _inherits(EllipseRenderer, _DefaultRenderer);\n  return _createClass(EllipseRenderer);\n}(DefaultRenderer);\nvar LineRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function LineRenderer() {\n    _classCallCheck(this, LineRenderer);\n    return _callSuper(this, LineRenderer, arguments);\n  }\n  _inherits(LineRenderer, _DefaultRenderer);\n  return _createClass(LineRenderer);\n}(DefaultRenderer);\nvar PolylineRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function PolylineRenderer() {\n    _classCallCheck(this, PolylineRenderer);\n    return _callSuper(this, PolylineRenderer, arguments);\n  }\n  _inherits(PolylineRenderer, _DefaultRenderer);\n  return _createClass(PolylineRenderer);\n}(DefaultRenderer);\nvar PolygonRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function PolygonRenderer() {\n    _classCallCheck(this, PolygonRenderer);\n    return _callSuper(this, PolygonRenderer, arguments);\n  }\n  _inherits(PolygonRenderer, _DefaultRenderer);\n  return _createClass(PolygonRenderer);\n}(DefaultRenderer);\nvar PathRenderer = /*#__PURE__*/function (_DefaultRenderer) {\n  function PathRenderer() {\n    _classCallCheck(this, PathRenderer);\n    return _callSuper(this, PathRenderer, arguments);\n  }\n  _inherits(PathRenderer, _DefaultRenderer);\n  return _createClass(PathRenderer);\n}(DefaultRenderer);\nvar Plugin = /*#__PURE__*/function (_AbstractRendererPlug) {\n  function Plugin() {\n    var _this;\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    _classCallCheck(this, Plugin);\n    _this = _callSuper(this, Plugin);\n    _this.name = 'canvas-renderer';\n    _this.options = options;\n    return _this;\n  }\n  _inherits(Plugin, _AbstractRendererPlug);\n  return _createClass(Plugin, [{\n    key: \"init\",\n    value: function init() {\n      var _defaultStyleRenderer;\n      var canvasRendererPluginOptions = _objectSpread({\n        dirtyObjectNumThreshold: 500,\n        dirtyObjectRatioThreshold: 0.8\n      }, this.options);\n\n      // @ts-ignore\n      var imagePool = this.context.imagePool;\n      var defaultRenderer = new DefaultRenderer(imagePool);\n      var defaultStyleRendererFactory = (_defaultStyleRenderer = {}, _defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defaultStyleRenderer, Shape.CIRCLE, defaultRenderer), Shape.ELLIPSE, defaultRenderer), Shape.RECT, defaultRenderer), Shape.IMAGE, new ImageRenderer(imagePool)), Shape.TEXT, new TextRenderer(imagePool)), Shape.LINE, defaultRenderer), Shape.POLYLINE, defaultRenderer), Shape.POLYGON, defaultRenderer), Shape.PATH, defaultRenderer), Shape.GROUP, undefined), _defineProperty(_defineProperty(_defaultStyleRenderer, Shape.HTML, undefined), Shape.MESH, undefined));\n      this.context.defaultStyleRendererFactory = defaultStyleRendererFactory;\n      this.context.styleRendererFactory = defaultStyleRendererFactory;\n      this.addRenderingPlugin(new CanvasRendererPlugin(canvasRendererPluginOptions));\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      this.removeAllRenderingPlugins();\n      delete this.context.defaultStyleRendererFactory;\n      delete this.context.styleRendererFactory;\n    }\n  }]);\n}(AbstractRendererPlugin);\nexport { CircleRenderer, EllipseRenderer, ImageRenderer, LineRenderer, PathRenderer, Plugin, PolygonRenderer, PolylineRenderer, RectRenderer, TextRenderer };","map":{"version":3,"names":["CanvasRendererPlugin","canvasRendererPluginOptions","_classCallCheck","removedRBushNodeAABBs","renderQueue","restoreStack","clearFullScreenLastFrame","clearFullScreen","vpMatrix","mat4","create","dprMatrix","tmpMat4","vec3a","vec3","vec3b","vec3c","vec3d","_createClass","key","value","apply","context","runtime","_this","config","camera","renderingService","renderingContext","rBushRoot","pathGeneratorFactory","rBush","contextService","canvas","root","ownerDocument","defaultView","handleUnmounted","e","object","target","rBushNode","aabb","push","handleCulled","hooks","init","tap","tag","addEventListener","ElementEvent","UNMOUNTED","CULLED","dpr","getDPR","width","height","getContext","clearRect","background","destroy","removeEventListener","beginFrame","_canvas$context$rende","_this$canvasRendererP","dirtyObjectNumThreshold","dirtyObjectRatioThreshold","_renderingService$get","getStats","total","rendered","ratio","renderingPlugins","isFirstTimeRenderingFinished","disableDirtyRectangleRendering","resetTransform","setTransform","_renderByZIndex","renderByZIndex","isVisible","isCulled","renderDisplayObject","sorted","sortable","childNodes","forEach","child","endFrame","length","fromScaling","multiply","getOrthoMatrix","dirtyRenderBounds","safeMergeAABB","mergeDirtyAABBs","concat","_toConsumableArray","map","_ref","minX","minY","maxX","maxY","AABB","setMinMax","isEmpty","dirtyRect","convertAABB2Rect","x","y","tl","transformMat4","tr","bl","br","minx","Math","min","miny","maxx","max","maxy","ix","floor","iy","iwidth","ceil","iheight","save","beginPath","rect","clip","_config$renderer$getC","renderer","getConfig","enableDirtyRectangleRenderingDebug","dispatchEvent","CustomEvent","CanvasEvent","DIRTY_RECTANGLE","dirtyObjects","searchDirtyObjects","sort","a","b","renderOrder","restore","saveDirtyAABB","render","fillStyle","fillRect","canvasContext","nodeName","parent","compareDocumentPosition","Node","DOCUMENT_POSITION_CONTAINS","pop","styleRenderer","styleRendererFactory","generatePath","_ref2","parsedStyle","clipPath","applyWorldTransform","_generatePath","closePath","applyAttributesToContext","Shape","LINE","PATH","POLYLINE","renderable","dirty","getMin","getMax","renderBounds","getRenderBounds","add","dirtyRectangle","_dirtyRectangle$getMi","_dirtyRectangle$getMi2","_slicedToArray","_dirtyRectangle$getMa","_dirtyRectangle$getMa2","rBushNodes","search","_ref3","displayObject","update","center","halfExtents","_ref4","stroke","fill","opacity","lineDash","lineDashOffset","setLineDash","isNil","globalAlpha","Array","isArray","isNone","strokeStyle","attributes","matrix","copy","getLocalTransform","getWorldTransform","merged","_len","arguments","aabbs","_key","DefaultRenderer","imagePool","plugin","fillRule","_parsedStyle$opacity","_parsedStyle$fillOpac","fillOpacity","_parsedStyle$strokeOp","strokeOpacity","_parsedStyle$lineWidt","lineWidth","lineCap","lineJoin","shadowType","shadowColor","shadowBlur","filter","miterLimit","hasFill","hasStroke","isFillTransparent","alpha","hasFilter","hasShadow","isInnerShadow","shouldDrawShadowWithStroke","setShadowAndFilter","applyFill","clearShadowAndFilter","globalCompositeOperation","applyStroke","oldFilter","indexOf","replace","trim","shadowOffsetX","shadowOffsetY","style","toString","getPattern","pattern","$offscreenCanvas","image","_parsedStyle","offscreenCanvas","offscreenCanvasCreator","getOrCreateCanvas","offscreenCanvasContext","getOrCreateContext","canvasPattern","getOrCreatePatternSync","getGeometryBounds","dirtify","getColor","parsedColor","color","type","GradientType","LinearGradient","RadialGradient","bounds","getOrCreateGradient","_objectSpread","skipFill","undefined","gradient","isPattern","skipStroke","calculateOverlapRect","rect1","rect2","_rect","x1","y1","w1","h1","_rect2","x2","y2","w2","h2","overlapLeft","overlapTop","overlapRight","overlapBottom","transformRect","_renderDownSampled","_classPrivateFieldLooseKey","_renderTile","ImageRenderer","Object","defineProperty","_renderTile2","_renderDownSampled2","_parsedStyle$x","_parsedStyle$y","src","imageCache","getImageSync","img","iw","ih","_object$ownerDocument","getContextService","getDomElement","viewWidth","viewHeight","currentTransform","getTransform","c","d","f","transformMatrix","fromValues","imageRect","drawRect","enableLargeImageOptimization","renderFull","sizeOfOrigin","size","downSamplingRate","_classPrivateFieldLooseBase","ImagePool","isSupportTile","_unused","data","drawImage","downSampled","createDownSampledImage","then","res","originalSize","_context$getTransform","gridSize","createImageTiles","scaleToOrigin","scaledTileSize","tileSize","startTileX","endTileX","startTileY","endTileY","tileY","tileX","item","tiles","tileRect","TextRenderer","getBounds","_parsedStyle$textAlig","textAlign","_parsedStyle$textBase","textBaseline","_parsedStyle$lineJoin","_parsedStyle$miterLim","_parsedStyle$letterSp","letterSpacing","metrics","dx","dy","font","lines","lineHeight","lineMetrics","formattedTextBaseline","linePositionY","offsetX","i","linePositionX","drawLetterSpacing","text","isStroke","strokeText","fillText","currentTextAlign","currentPosition","stringArray","from","previousWidth","measureText","currentWidth","currentChar","substring","currentGlobalAlpha","applyOpacity","RectRenderer","_DefaultRenderer","_callSuper","_inherits","CircleRenderer","EllipseRenderer","LineRenderer","PolylineRenderer","PolygonRenderer","PathRenderer","Plugin","_AbstractRendererPlug","options","name","_defaultStyleRenderer","defaultRenderer","defaultStyleRendererFactory","_defineProperty","CIRCLE","ELLIPSE","RECT","IMAGE","TEXT","POLYGON","GROUP","HTML","MESH","addRenderingPlugin","removeAllRenderingPlugins","AbstractRendererPlugin"],"sources":["/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/CanvasRendererPlugin.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Default.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/utils/math.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Image.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Text.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Rect.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Circle.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Ellipse.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Line.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Polyline.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Polygon.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/shapes/styles/Path.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-canvas-renderer/src/index.ts"],"sourcesContent":["import type {\n  CSSRGB,\n  DisplayObject,\n  FederatedEvent,\n  ParsedBaseStyleProps,\n  RBushNodeAABB,\n  RenderingPlugin,\n  RBush,\n  RenderingPluginContext,\n  ContextService,\n  CanvasContext,\n  GlobalRuntime,\n} from '@antv/g-lite';\nimport {\n  AABB,\n  CanvasEvent,\n  CustomEvent,\n  ElementEvent,\n  Shape,\n  Node,\n} from '@antv/g-lite';\nimport type { PathGenerator } from '@antv/g-plugin-canvas-path-generator';\nimport { isNil } from '@antv/util';\nimport { mat4, vec3 } from 'gl-matrix';\nimport type { CanvasRendererPluginOptions } from './interfaces';\n\ninterface Rect {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\n/**\n * support 2 modes in rendering:\n * * immediate\n * * delayed: render at the end of frame with dirty-rectangle\n */\nexport class CanvasRendererPlugin implements RenderingPlugin {\n  static tag = 'CanvasRenderer';\n\n  private context: RenderingPluginContext;\n\n  private pathGeneratorFactory: Record<Shape, PathGenerator<any>>;\n\n  /**\n   * RBush used in dirty rectangle rendering\n   */\n  private rBush: RBush<RBushNodeAABB>;\n\n  constructor(\n    private canvasRendererPluginOptions: CanvasRendererPluginOptions, // private styleRendererFactory: Record<Shape, StyleRenderer>,\n  ) {}\n\n  private removedRBushNodeAABBs: RBushNodeAABB[] = [];\n\n  private renderQueue: DisplayObject[] = [];\n\n  /**\n   * This stack is only used by clipPath for now.\n   */\n  private restoreStack: DisplayObject[] = [];\n\n  private clearFullScreenLastFrame = false;\n  private clearFullScreen = false;\n\n  /**\n   * view projection matrix\n   */\n  private vpMatrix = mat4.create();\n  private dprMatrix = mat4.create();\n  private tmpMat4 = mat4.create();\n  private vec3a = vec3.create();\n  private vec3b = vec3.create();\n  private vec3c = vec3.create();\n  private vec3d = vec3.create();\n\n  apply(context: RenderingPluginContext, runtime: GlobalRuntime) {\n    this.context = context;\n\n    const {\n      config,\n      camera,\n      renderingService,\n      renderingContext,\n      rBushRoot,\n      // @ts-ignore\n      pathGeneratorFactory,\n    } = context;\n    this.rBush = rBushRoot;\n    this.pathGeneratorFactory = pathGeneratorFactory;\n    const contextService =\n      context.contextService as ContextService<CanvasRenderingContext2D>;\n\n    const canvas = renderingContext.root.ownerDocument.defaultView;\n\n    const handleUnmounted = (e: FederatedEvent) => {\n      const object = e.target as DisplayObject;\n\n      // remove r-bush node\n      // @ts-ignore\n      const { rBushNode } = object;\n\n      if (rBushNode.aabb) {\n        // save removed aabbs for dirty-rectangle rendering later\n        this.removedRBushNodeAABBs.push(rBushNode.aabb);\n      }\n    };\n\n    const handleCulled = (e: FederatedEvent) => {\n      const object = e.target as DisplayObject;\n      // @ts-ignore\n      const { rBushNode } = object;\n\n      if (rBushNode.aabb) {\n        // save removed aabbs for dirty-rectangle rendering later\n        this.removedRBushNodeAABBs.push(rBushNode.aabb);\n      }\n    };\n\n    renderingService.hooks.init.tap(CanvasRendererPlugin.tag, () => {\n      canvas.addEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n      canvas.addEventListener(ElementEvent.CULLED, handleCulled);\n\n      // clear fullscreen\n      const dpr = contextService.getDPR();\n      const { width, height } = config;\n      const context = contextService.getContext();\n      this.clearRect(\n        context,\n        0,\n        0,\n        width * dpr,\n        height * dpr,\n        config.background,\n      );\n    });\n\n    renderingService.hooks.destroy.tap(CanvasRendererPlugin.tag, () => {\n      canvas.removeEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n      canvas.removeEventListener(ElementEvent.CULLED, handleCulled);\n      this.renderQueue = [];\n      this.removedRBushNodeAABBs = [];\n      this.restoreStack = [];\n    });\n\n    renderingService.hooks.beginFrame.tap(CanvasRendererPlugin.tag, () => {\n      const context = contextService.getContext();\n      const dpr = contextService.getDPR();\n      const { width, height } = config;\n      const { dirtyObjectNumThreshold, dirtyObjectRatioThreshold } =\n        this.canvasRendererPluginOptions;\n\n      // some heuristic conditions such as 80% object changed\n      const { total, rendered } = renderingService.getStats();\n      const ratio = rendered / total;\n\n      this.clearFullScreen =\n        this.clearFullScreenLastFrame ||\n        // @ts-ignore\n        !canvas.context.renderingPlugins[1]?.isFirstTimeRenderingFinished ||\n        renderingService.disableDirtyRectangleRendering() ||\n        (rendered > dirtyObjectNumThreshold &&\n          ratio > dirtyObjectRatioThreshold);\n\n      if (context) {\n        context.resetTransform\n          ? context.resetTransform()\n          : context.setTransform(1, 0, 0, 1, 0, 0);\n        if (this.clearFullScreen) {\n          this.clearRect(\n            context,\n            0,\n            0,\n            width * dpr,\n            height * dpr,\n            config.background,\n          );\n        }\n      }\n    });\n\n    const renderByZIndex = (\n      object: DisplayObject,\n      context: CanvasRenderingContext2D,\n    ) => {\n      if (object.isVisible() && !object.isCulled()) {\n        this.renderDisplayObject(\n          object,\n          context,\n          this.context,\n          this.restoreStack,\n          runtime,\n        );\n      }\n\n      const sorted = object.sortable.sorted || object.childNodes;\n\n      // should account for z-index\n      sorted.forEach((child: DisplayObject) => {\n        renderByZIndex(child, context);\n      });\n    };\n\n    // render at the end of frame\n    renderingService.hooks.endFrame.tap(CanvasRendererPlugin.tag, () => {\n      // Skip rendering.\n      if (renderingContext.root.childNodes.length === 0) {\n        this.clearFullScreenLastFrame = true;\n        return;\n      }\n\n      this.clearFullScreenLastFrame = false;\n\n      const context = contextService.getContext();\n      // clear & clip dirty rectangle\n      const dpr = contextService.getDPR();\n      mat4.fromScaling(this.dprMatrix, [dpr, dpr, 1]);\n      mat4.multiply(this.vpMatrix, this.dprMatrix, camera.getOrthoMatrix());\n\n      if (this.clearFullScreen) {\n        // console.log('canvas renderer fcp...', renderingContext.root.childNodes);\n        renderByZIndex(renderingContext.root, context);\n      } else {\n        // console.log('canvas renderer next...', this.renderQueue);\n        // merge removed AABB\n        const dirtyRenderBounds = this.safeMergeAABB(\n          this.mergeDirtyAABBs(this.renderQueue),\n          ...this.removedRBushNodeAABBs.map(({ minX, minY, maxX, maxY }) => {\n            const aabb = new AABB();\n            aabb.setMinMax(\n              // vec3.fromValues(minX, minY, 0),\n              // vec3.fromValues(maxX, maxY, 0),\n              [minX, minY, 0],\n              [maxX, maxY, 0],\n            );\n            return aabb;\n          }),\n        );\n        this.removedRBushNodeAABBs = [];\n\n        if (AABB.isEmpty(dirtyRenderBounds)) {\n          this.renderQueue = [];\n          return;\n        }\n\n        const dirtyRect = this.convertAABB2Rect(dirtyRenderBounds);\n        const { x, y, width, height } = dirtyRect;\n\n        const tl = vec3.transformMat4(this.vec3a, [x, y, 0], this.vpMatrix);\n        const tr = vec3.transformMat4(\n          this.vec3b,\n          [x + width, y, 0],\n          this.vpMatrix,\n        );\n        const bl = vec3.transformMat4(\n          this.vec3c,\n          [x, y + height, 0],\n          this.vpMatrix,\n        );\n        const br = vec3.transformMat4(\n          this.vec3d,\n          [x + width, y + height, 0],\n          this.vpMatrix,\n        );\n\n        const minx = Math.min(tl[0], tr[0], br[0], bl[0]);\n        const miny = Math.min(tl[1], tr[1], br[1], bl[1]);\n        const maxx = Math.max(tl[0], tr[0], br[0], bl[0]);\n        const maxy = Math.max(tl[1], tr[1], br[1], bl[1]);\n\n        const ix = Math.floor(minx);\n        const iy = Math.floor(miny);\n        const iwidth = Math.ceil(maxx - minx);\n        const iheight = Math.ceil(maxy - miny);\n\n        context.save();\n        this.clearRect(context, ix, iy, iwidth, iheight, config.background);\n        context.beginPath();\n        context.rect(ix, iy, iwidth, iheight);\n        context.clip();\n\n        // @see https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Transformations\n        context.setTransform(\n          this.vpMatrix[0],\n          this.vpMatrix[1],\n          this.vpMatrix[4],\n          this.vpMatrix[5],\n          this.vpMatrix[12],\n          this.vpMatrix[13],\n        );\n\n        // draw dirty rectangle\n        const { enableDirtyRectangleRenderingDebug } =\n          config.renderer.getConfig();\n        if (enableDirtyRectangleRenderingDebug) {\n          canvas.dispatchEvent(\n            new CustomEvent(CanvasEvent.DIRTY_RECTANGLE, {\n              dirtyRect: {\n                x: ix,\n                y: iy,\n                width: iwidth,\n                height: iheight,\n              },\n            }),\n          );\n        }\n\n        // search objects intersect with dirty rectangle\n        const dirtyObjects = this.searchDirtyObjects(dirtyRenderBounds);\n\n        // do rendering\n        dirtyObjects\n          // sort by z-index\n          .sort((a, b) => a.sortable.renderOrder - b.sortable.renderOrder)\n          .forEach((object) => {\n            // culled object should not be rendered\n            if (object && object.isVisible() && !object.isCulled()) {\n              this.renderDisplayObject(\n                object,\n                context,\n                this.context,\n                this.restoreStack,\n                runtime,\n              );\n            }\n          });\n\n        context.restore();\n\n        // save dirty AABBs in last frame\n        this.renderQueue.forEach((object) => {\n          this.saveDirtyAABB(object);\n        });\n\n        // clear queue\n        this.renderQueue = [];\n      }\n\n      // pop restore stack, eg. root -> parent -> child\n      this.restoreStack.forEach(() => {\n        context.restore();\n      });\n      // clear restore stack\n      this.restoreStack = [];\n    });\n\n    renderingService.hooks.render.tap(\n      CanvasRendererPlugin.tag,\n      (object: DisplayObject) => {\n        if (!this.clearFullScreen) {\n          // render at the end of frame\n          this.renderQueue.push(object);\n        }\n      },\n    );\n  }\n\n  private clearRect(\n    context: CanvasRenderingContext2D,\n    x: number,\n    y: number,\n    width: number,\n    height: number,\n    background: string,\n  ) {\n    // clearRect is faster than fillRect @see https://stackoverflow.com/a/30830253\n    context.clearRect(x, y, width, height);\n    if (background) {\n      context.fillStyle = background;\n      context.fillRect(x, y, width, height);\n    }\n  }\n\n  renderDisplayObject(\n    object: DisplayObject,\n    context: CanvasRenderingContext2D,\n    canvasContext: CanvasContext,\n    restoreStack: DisplayObject[],\n    runtime: GlobalRuntime,\n  ) {\n    const { nodeName } = object;\n\n    // console.log('canvas render:', object);\n\n    // restore to its ancestor\n\n    const parent = restoreStack[restoreStack.length - 1];\n    if (\n      parent &&\n      !(\n        object.compareDocumentPosition(parent) & Node.DOCUMENT_POSITION_CONTAINS\n      )\n    ) {\n      context.restore();\n      restoreStack.pop();\n    }\n\n    // @ts-ignore\n    const styleRenderer = this.context.styleRendererFactory[nodeName];\n    const generatePath = this.pathGeneratorFactory[nodeName];\n\n    // clip path\n    const { clipPath } = object.parsedStyle as ParsedBaseStyleProps;\n    if (clipPath) {\n      this.applyWorldTransform(context, clipPath);\n\n      // generate path in local space\n      const generatePath = this.pathGeneratorFactory[clipPath.nodeName];\n      if (generatePath) {\n        context.save();\n\n        // save clip\n        restoreStack.push(object);\n\n        context.beginPath();\n        generatePath(context, clipPath.parsedStyle);\n        context.closePath();\n        context.clip();\n      }\n    }\n\n    // fill & stroke\n\n    if (styleRenderer) {\n      this.applyWorldTransform(context, object);\n\n      context.save();\n\n      // apply attributes to context\n      this.applyAttributesToContext(context, object);\n    }\n\n    if (generatePath) {\n      context.beginPath();\n      generatePath(context, object.parsedStyle);\n      if (\n        object.nodeName !== Shape.LINE &&\n        object.nodeName !== Shape.PATH &&\n        object.nodeName !== Shape.POLYLINE\n      ) {\n        context.closePath();\n      }\n    }\n\n    // fill & stroke\n    if (styleRenderer) {\n      styleRenderer.render(\n        context,\n        object.parsedStyle,\n        object,\n        canvasContext,\n        this,\n        runtime,\n      );\n\n      // restore applied attributes, eg. shadowBlur shadowColor...\n      context.restore();\n    }\n\n    // finish rendering, clear dirty flag\n    object.renderable.dirty = false;\n  }\n\n  private convertAABB2Rect(aabb: AABB): Rect {\n    const min = aabb.getMin();\n    const max = aabb.getMax();\n    // expand the rectangle a bit to avoid artifacts\n    // @see https://www.yuque.com/antv/ou292n/bi8nix#ExvCu\n    const minX = Math.floor(min[0]);\n    const minY = Math.floor(min[1]);\n    const maxX = Math.ceil(max[0]);\n    const maxY = Math.ceil(max[1]);\n    const width = maxX - minX;\n    const height = maxY - minY;\n\n    return { x: minX, y: minY, width, height };\n  }\n\n  /**\n   * TODO: merge dirty rectangles with some strategies.\n   * For now, we just simply merge all the rectangles into one.\n   * @see https://idom.me/articles/841.html\n   */\n  private mergeDirtyAABBs(dirtyObjects: DisplayObject[]): AABB {\n    // merge into a big AABB\n    // TODO: skip descendant if ancestor is caculated, but compareNodePosition is really slow\n    const aabb = new AABB();\n    dirtyObjects.forEach((object) => {\n      const renderBounds = object.getRenderBounds();\n      aabb.add(renderBounds);\n\n      const { dirtyRenderBounds } = object.renderable;\n      if (dirtyRenderBounds) {\n        aabb.add(dirtyRenderBounds);\n      }\n    });\n\n    return aabb;\n  }\n\n  private searchDirtyObjects(dirtyRectangle: AABB): DisplayObject[] {\n    // search in r-tree, get all affected nodes\n    const [minX, minY] = dirtyRectangle.getMin();\n    const [maxX, maxY] = dirtyRectangle.getMax();\n    const rBushNodes = this.rBush.search({\n      minX,\n      minY,\n      maxX,\n      maxY,\n    });\n\n    return rBushNodes.map(({ displayObject }) => displayObject);\n  }\n\n  private saveDirtyAABB(object: DisplayObject) {\n    const { renderable } = object;\n    if (!renderable.dirtyRenderBounds) {\n      renderable.dirtyRenderBounds = new AABB();\n    }\n    const renderBounds = object.getRenderBounds();\n    if (renderBounds) {\n      // save last dirty aabb\n      renderable.dirtyRenderBounds.update(\n        renderBounds.center,\n        renderBounds.halfExtents,\n      );\n    }\n  }\n\n  /**\n   * TODO: batch the same global attributes\n   */\n  private applyAttributesToContext(\n    context: CanvasRenderingContext2D,\n    object: DisplayObject,\n  ) {\n    const { stroke, fill, opacity, lineDash, lineDashOffset } =\n      object.parsedStyle as ParsedBaseStyleProps;\n    // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/setLineDash\n    if (lineDash) {\n      context.setLineDash(lineDash);\n    }\n\n    // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineDashOffset\n    if (!isNil(lineDashOffset)) {\n      context.lineDashOffset = lineDashOffset;\n    }\n\n    if (!isNil(opacity)) {\n      context.globalAlpha *= opacity;\n    }\n\n    if (\n      !isNil(stroke) &&\n      !Array.isArray(stroke) &&\n      !(stroke as CSSRGB).isNone\n    ) {\n      context.strokeStyle = object.attributes.stroke;\n    }\n\n    if (!isNil(fill) && !Array.isArray(fill) && !(fill as CSSRGB).isNone) {\n      context.fillStyle = object.attributes.fill;\n    }\n  }\n\n  private applyWorldTransform(\n    context: CanvasRenderingContext2D,\n    object: DisplayObject,\n    matrix?: mat4,\n  ) {\n    // apply clip shape's RTS\n    if (matrix) {\n      mat4.copy(this.tmpMat4, object.getLocalTransform());\n      mat4.multiply(this.tmpMat4, matrix, this.tmpMat4);\n      mat4.multiply(this.tmpMat4, this.vpMatrix, this.tmpMat4);\n    } else {\n      // apply RTS transformation in world space\n      mat4.copy(this.tmpMat4, object.getWorldTransform());\n      mat4.multiply(this.tmpMat4, this.vpMatrix, this.tmpMat4);\n    }\n\n    // @see https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Transformations\n    context.setTransform(\n      this.tmpMat4[0],\n      this.tmpMat4[1],\n      this.tmpMat4[4],\n      this.tmpMat4[5],\n      this.tmpMat4[12],\n      this.tmpMat4[13],\n    );\n  }\n\n  private safeMergeAABB(...aabbs: AABB[]): AABB {\n    const merged = new AABB();\n    aabbs.forEach((aabb) => {\n      merged.add(aabb);\n    });\n    return merged;\n  }\n}\n","import {\n  CanvasContext,\n  CSSGradientValue,\n  CSSRGB,\n  DisplayObject,\n  GlobalRuntime,\n  LinearGradient,\n  ParsedBaseStyleProps,\n  Pattern,\n  RadialGradient,\n  Rect,\n  GradientType,\n  isPattern,\n  Shape,\n} from '@antv/g-lite';\nimport type { ImagePool } from '@antv/g-plugin-image-loader';\nimport { isNil } from '@antv/util';\nimport { CanvasRendererPlugin } from '../../CanvasRendererPlugin';\nimport type { StyleRenderer } from './interfaces';\n\nexport class DefaultRenderer implements StyleRenderer {\n  constructor(private imagePool: ImagePool) {}\n\n  render(\n    context: CanvasRenderingContext2D,\n    parsedStyle: ParsedBaseStyleProps,\n    object: DisplayObject,\n    canvasContext: CanvasContext,\n    plugin: CanvasRendererPlugin,\n    runtime: GlobalRuntime,\n  ) {\n    const {\n      fill,\n      fillRule,\n      opacity = 1,\n      fillOpacity = 1,\n      stroke,\n      strokeOpacity = 1,\n      lineWidth = 1,\n      lineCap,\n      lineJoin,\n      shadowType,\n      shadowColor,\n      shadowBlur,\n      filter,\n      miterLimit,\n    } = parsedStyle;\n    const hasFill = fill && !(fill as CSSRGB).isNone;\n    const hasStroke = stroke && !(stroke as CSSRGB).isNone && lineWidth > 0;\n\n    const isFillTransparent = (fill as CSSRGB)?.alpha === 0;\n    const hasFilter = !!(filter && filter.length);\n    const hasShadow = !isNil(shadowColor) && shadowBlur > 0;\n    const { nodeName } = object;\n    const isInnerShadow = shadowType === 'inner';\n    const shouldDrawShadowWithStroke =\n      hasStroke &&\n      hasShadow &&\n      (nodeName === Shape.PATH ||\n        nodeName === Shape.LINE ||\n        nodeName === Shape.POLYLINE ||\n        isFillTransparent ||\n        isInnerShadow);\n\n    if (hasFill) {\n      context.globalAlpha = opacity * fillOpacity;\n\n      if (!shouldDrawShadowWithStroke) {\n        setShadowAndFilter(object, context, hasShadow);\n      }\n\n      applyFill(\n        context,\n        object,\n        fill,\n        fillRule,\n        canvasContext,\n        plugin,\n        runtime,\n        this.imagePool,\n      );\n\n      if (!shouldDrawShadowWithStroke) {\n        this.clearShadowAndFilter(context, hasFilter, hasShadow);\n      }\n    }\n\n    if (hasStroke) {\n      context.globalAlpha = opacity * strokeOpacity;\n      context.lineWidth = lineWidth;\n      if (!isNil(miterLimit)) {\n        context.miterLimit = miterLimit;\n      }\n\n      if (!isNil(lineCap)) {\n        context.lineCap = lineCap;\n      }\n\n      if (!isNil(lineJoin)) {\n        context.lineJoin = lineJoin;\n      }\n\n      if (shouldDrawShadowWithStroke) {\n        if (isInnerShadow) {\n          context.globalCompositeOperation = 'source-atop';\n        }\n        setShadowAndFilter(object, context, true);\n\n        if (isInnerShadow) {\n          applyStroke(\n            context,\n            object,\n            stroke,\n            canvasContext,\n            plugin,\n            runtime,\n            this.imagePool,\n          );\n          context.globalCompositeOperation = 'source-over';\n          this.clearShadowAndFilter(context, hasFilter, true);\n        }\n      }\n\n      applyStroke(\n        context,\n        object,\n        stroke,\n        canvasContext,\n        plugin,\n        runtime,\n        this.imagePool,\n      );\n    }\n  }\n\n  private clearShadowAndFilter(\n    context: CanvasRenderingContext2D,\n    hasFilter: boolean,\n    hasShadow: boolean,\n  ) {\n    if (hasShadow) {\n      context.shadowColor = 'transparent';\n      context.shadowBlur = 0;\n    }\n\n    if (hasFilter) {\n      // save drop-shadow filter\n      const oldFilter = context.filter;\n      if (!isNil(oldFilter) && oldFilter.indexOf('drop-shadow') > -1) {\n        context.filter =\n          oldFilter.replace(/drop-shadow\\([^)]*\\)/, '').trim() || 'none';\n      }\n    }\n  }\n}\n\n/**\n * apply before fill and stroke but only once\n */\nexport function setShadowAndFilter(\n  object: DisplayObject,\n  context: CanvasRenderingContext2D,\n  hasShadow: boolean,\n) {\n  const { filter, shadowColor, shadowBlur, shadowOffsetX, shadowOffsetY } =\n    object.parsedStyle as ParsedBaseStyleProps;\n\n  if (filter && filter.length) {\n    // use raw filter string\n    context.filter = object.style.filter;\n  }\n\n  if (hasShadow) {\n    context.shadowColor = shadowColor.toString();\n    context.shadowBlur = shadowBlur || 0;\n    context.shadowOffsetX = shadowOffsetX || 0;\n    context.shadowOffsetY = shadowOffsetY || 0;\n  }\n}\n\nexport function getPattern(\n  pattern: Pattern,\n  object: DisplayObject,\n  context: CanvasRenderingContext2D,\n  canvasContext: CanvasContext,\n  plugin: CanvasRendererPlugin,\n  runtime: GlobalRuntime,\n  imagePool: ImagePool,\n): CanvasPattern {\n  let $offscreenCanvas: HTMLCanvasElement;\n  let dpr: number;\n  if ((pattern.image as Rect).nodeName === 'rect') {\n    const { width, height } = (pattern.image as Rect).parsedStyle;\n    dpr = canvasContext.contextService.getDPR();\n    const { offscreenCanvas } = canvasContext.config;\n    $offscreenCanvas = runtime.offscreenCanvasCreator.getOrCreateCanvas(\n      offscreenCanvas,\n    ) as HTMLCanvasElement;\n\n    $offscreenCanvas.width = width * dpr;\n    $offscreenCanvas.height = height * dpr;\n\n    const offscreenCanvasContext =\n      runtime.offscreenCanvasCreator.getOrCreateContext(\n        offscreenCanvas,\n      ) as CanvasRenderingContext2D;\n\n    const restoreStack = [];\n\n    // offscreenCanvasContext.scale(1 / dpr, 1 / dpr);\n\n    (pattern.image as Rect).forEach((object: DisplayObject) => {\n      plugin.renderDisplayObject(\n        object,\n        offscreenCanvasContext,\n        canvasContext,\n        restoreStack,\n        runtime,\n      );\n    });\n\n    restoreStack.forEach(() => {\n      offscreenCanvasContext.restore();\n    });\n  }\n\n  const canvasPattern = imagePool.getOrCreatePatternSync(\n    object,\n    pattern,\n    context,\n    $offscreenCanvas,\n    dpr,\n    object.getGeometryBounds().min,\n    () => {\n      // set dirty rectangle flag\n      object.renderable.dirty = true;\n      canvasContext.renderingService.dirtify();\n    },\n  );\n\n  return canvasPattern;\n}\n\nexport function getColor(\n  parsedColor: CSSGradientValue,\n  object: DisplayObject,\n  context: CanvasRenderingContext2D,\n  imagePool: ImagePool,\n) {\n  let color: CanvasGradient | string;\n\n  if (\n    parsedColor.type === GradientType.LinearGradient ||\n    parsedColor.type === GradientType.RadialGradient\n  ) {\n    const bounds = object.getGeometryBounds();\n    const width = (bounds && bounds.halfExtents[0] * 2) || 1;\n    const height = (bounds && bounds.halfExtents[1] * 2) || 1;\n    const min = (bounds && bounds.min) || [0, 0];\n    color = imagePool.getOrCreateGradient(\n      {\n        type: parsedColor.type,\n        ...(parsedColor.value as LinearGradient & RadialGradient),\n        min: min as [number, number],\n        width,\n        height,\n      },\n      context,\n    );\n  }\n\n  return color;\n}\n\nexport function applyFill(\n  context: CanvasRenderingContext2D,\n  object: DisplayObject,\n  fill: CSSRGB | CSSGradientValue[] | Pattern,\n  fillRule: 'nonzero' | 'evenodd',\n  canvasContext: CanvasContext,\n  plugin: CanvasRendererPlugin,\n  runtime: GlobalRuntime,\n  imagePool: ImagePool,\n  skipFill = false,\n) {\n  if (Array.isArray(fill)) {\n    fill.forEach((gradient) => {\n      context.fillStyle = getColor(gradient, object, context, imagePool);\n      if (!skipFill) {\n        fillRule ? context.fill(fillRule) : context.fill();\n      }\n    });\n  } else {\n    if (isPattern(fill)) {\n      context.fillStyle = getPattern(\n        fill,\n        object,\n        context,\n        canvasContext,\n        plugin,\n        runtime,\n        imagePool,\n      );\n    }\n    if (!skipFill) {\n      fillRule ? context.fill(fillRule) : context.fill();\n    }\n  }\n}\n\nexport function applyStroke(\n  context: CanvasRenderingContext2D,\n  object: DisplayObject,\n  stroke: CSSRGB | CSSGradientValue[] | Pattern,\n  canvasContext: CanvasContext,\n  plugin: CanvasRendererPlugin,\n  runtime: GlobalRuntime,\n  imagePool: ImagePool,\n  skipStroke = false,\n) {\n  if (Array.isArray(stroke)) {\n    stroke.forEach((gradient) => {\n      context.strokeStyle = getColor(gradient, object, context, imagePool);\n      if (!skipStroke) {\n        context.stroke();\n      }\n    });\n  } else {\n    if (isPattern(stroke)) {\n      context.strokeStyle = getPattern(\n        stroke,\n        object,\n        context,\n        canvasContext,\n        plugin,\n        runtime,\n        imagePool,\n      );\n    }\n    if (!skipStroke) {\n      context.stroke();\n    }\n  }\n}\n","import { vec3, mat4 } from 'gl-matrix';\n\n/**\n * 判断两个点是否重合，点坐标的格式为 [x, y]\n */\nexport function isSamePoint(\n  point1: [number, number],\n  point2: [number, number],\n) {\n  return point1[0] === point2[0] && point1[1] === point2[1];\n}\n\nexport function calculateOverlapRect<\n  Rect extends [number, number, number, number],\n>(rect1: Rect, rect2: Rect): null | Rect {\n  const [x1, y1, w1, h1] = rect1;\n  const [x2, y2, w2, h2] = rect2;\n\n  // 计算重叠区域的左上角和右下角\n  const overlapLeft = Math.max(x1, x2);\n  const overlapTop = Math.max(y1, y2);\n  const overlapRight = Math.min(x1 + w1, x2 + w2);\n  const overlapBottom = Math.min(y1 + h1, y2 + h2);\n\n  if (overlapRight <= overlapLeft || overlapBottom <= overlapTop) {\n    return null;\n  }\n\n  return [\n    overlapLeft,\n    overlapTop,\n    overlapRight - overlapLeft,\n    overlapBottom - overlapTop,\n  ] as Rect;\n}\n\nexport function transformRect<Rect extends [number, number, number, number]>(\n  rect: Rect,\n  matrix: mat4,\n): Rect {\n  const tl = vec3.transformMat4(vec3.create(), [rect[0], rect[1], 0], matrix);\n  const tr = vec3.transformMat4(\n    vec3.create(),\n    [rect[0] + rect[2], rect[1], 0],\n    matrix,\n  );\n  const bl = vec3.transformMat4(\n    vec3.create(),\n    [rect[0], rect[1] + rect[3], 0],\n    matrix,\n  );\n  const br = vec3.transformMat4(\n    vec3.create(),\n    [rect[0] + rect[2], rect[1] + rect[3], 0],\n    matrix,\n  );\n\n  return [\n    Math.min(tl[0], tr[0], bl[0], br[0]),\n    Math.min(tl[1], tr[1], bl[1], br[1]),\n    Math.max(tl[0], tr[0], bl[0], br[0]) - Math.min(tl[0], tr[0], bl[0], br[0]),\n    Math.max(tl[1], tr[1], bl[1], br[1]) - Math.min(tl[1], tr[1], bl[1], br[1]),\n  ] as Rect;\n}\n","import type { DisplayObject, ParsedImageStyleProps } from '@antv/g-lite';\nimport { ImagePool, type ImageCache } from '@antv/g-plugin-image-loader';\nimport { isNil } from '@antv/util';\nimport { mat4 } from 'gl-matrix';\nimport { setShadowAndFilter } from './Default';\nimport type { StyleRenderer } from './interfaces';\nimport { transformRect, calculateOverlapRect } from '../../utils/math';\n\nexport class ImageRenderer implements StyleRenderer {\n  constructor(private imagePool: ImagePool) {}\n\n  static renderFull(\n    context: CanvasRenderingContext2D,\n    parsedStyle: ParsedImageStyleProps,\n    object: DisplayObject,\n    data: {\n      image: HTMLImageElement;\n      drawRect: [number, number, number, number];\n    },\n  ) {\n    context.drawImage(\n      data.image,\n      Math.floor(data.drawRect[0]),\n      Math.floor(data.drawRect[1]),\n      Math.ceil(data.drawRect[2]),\n      Math.ceil(data.drawRect[3]),\n    );\n  }\n\n  #renderDownSampled(\n    context: CanvasRenderingContext2D,\n    parsedStyle: ParsedImageStyleProps,\n    object: DisplayObject,\n    data: {\n      src: string | HTMLImageElement;\n      imageCache: ImageCache;\n      drawRect: [number, number, number, number];\n    },\n  ) {\n    const { src, imageCache } = data;\n\n    if (!imageCache.downSampled) {\n      this.imagePool\n        .createDownSampledImage(src, object)\n        .then((res) => {\n          // rerender\n          object.renderable.dirty = true;\n          object.ownerDocument.defaultView.context.renderingService.dirtify();\n        })\n        .catch(() => {\n          //\n        });\n\n      return;\n    }\n\n    context.drawImage(\n      imageCache.downSampled,\n      Math.floor(data.drawRect[0]),\n      Math.floor(data.drawRect[1]),\n      Math.ceil(data.drawRect[2]),\n      Math.ceil(data.drawRect[3]),\n    );\n  }\n\n  #renderTile(\n    context: CanvasRenderingContext2D,\n    parsedStyle: ParsedImageStyleProps,\n    object: DisplayObject,\n    data: {\n      src: string | HTMLImageElement;\n      imageCache: ImageCache;\n      imageRect: [number, number, number, number];\n      drawRect: [number, number, number, number];\n    },\n  ) {\n    const { src, imageCache, imageRect, drawRect } = data;\n    const { size: originalSize } = imageCache;\n    const { a, b, c, d, e, f } = context.getTransform();\n\n    context.resetTransform();\n\n    if (!imageCache?.gridSize) {\n      this.imagePool\n        .createImageTiles(src, [], object)\n        .then(() => {\n          // rerender\n          object.renderable.dirty = true;\n          object.ownerDocument.defaultView.context.renderingService.dirtify();\n        })\n        .catch(() => {\n          //\n        });\n\n      return;\n    }\n\n    const scaleToOrigin = [\n      originalSize[0] / imageRect[2],\n      originalSize[1] / imageRect[3],\n    ];\n    const scaledTileSize = [\n      imageCache.tileSize[0] / scaleToOrigin[0],\n      imageCache.tileSize[1] / scaleToOrigin[1],\n    ];\n    const [startTileX, endTileX] = [\n      Math.floor((drawRect[0] - imageRect[0]) / scaledTileSize[0]),\n      Math.ceil((drawRect[0] + drawRect[2] - imageRect[0]) / scaledTileSize[0]),\n    ];\n    const [startTileY, endTileY] = [\n      Math.floor((drawRect[1] - imageRect[1]) / scaledTileSize[1]),\n      Math.ceil((drawRect[1] + drawRect[3] - imageRect[1]) / scaledTileSize[1]),\n    ];\n\n    for (let tileY = startTileY; tileY <= endTileY; tileY++) {\n      for (let tileX = startTileX; tileX <= endTileX; tileX++) {\n        const item = imageCache.tiles[tileY][tileX];\n\n        if (item) {\n          const tileRect = [\n            Math.floor(imageRect[0] + item.tileX * scaledTileSize[0]),\n            Math.floor(imageRect[1] + item.tileY * scaledTileSize[1]),\n            Math.ceil(scaledTileSize[0]),\n            Math.ceil(scaledTileSize[1]),\n          ];\n\n          context.drawImage(\n            item.data,\n            tileRect[0],\n            tileRect[1],\n            tileRect[2],\n            tileRect[3],\n          );\n        }\n      }\n    }\n\n    context.setTransform(a, b, c, d, e, f);\n  }\n\n  render(\n    context: CanvasRenderingContext2D,\n    parsedStyle: ParsedImageStyleProps,\n    object: DisplayObject,\n  ) {\n    const {\n      x = 0,\n      y = 0,\n      width,\n      height,\n      src,\n      shadowColor,\n      shadowBlur,\n    } = parsedStyle;\n\n    const imageCache = this.imagePool.getImageSync(src, object);\n    const image = imageCache?.img;\n    let iw = width;\n    let ih = height;\n\n    if (!image) {\n      return;\n    }\n\n    iw ||= image.width;\n    ih ||= image.height;\n\n    const hasShadow = !isNil(shadowColor) && shadowBlur > 0;\n    setShadowAndFilter(object, context, hasShadow);\n\n    // node-canvas will throw the following err:\n    // Error: Image given has not completed loading\n    try {\n      const { width: viewWidth, height: viewHeight } =\n        object.ownerDocument.defaultView.getContextService().getDomElement();\n\n      const currentTransform = context.getTransform();\n      const { a, b, c, d, e, f } = currentTransform;\n      // 构建 mat4 矩阵\n      // prettier-ignore\n      const transformMatrix = mat4.fromValues(\n          a, c, 0, 0,\n          b, d, 0, 0,\n          0, 0, 1, 0,\n          e, f, 0, 1,\n        );\n      const imageRect = transformRect([x, y, iw, ih], transformMatrix);\n      const drawRect = calculateOverlapRect(\n        [0, 0, viewWidth, viewHeight],\n        imageRect,\n      );\n\n      if (!drawRect) {\n        return;\n      }\n\n      if (\n        !object.ownerDocument.defaultView.getConfig()\n          .enableLargeImageOptimization\n      ) {\n        ImageRenderer.renderFull(context, parsedStyle, object, {\n          image,\n          drawRect: [x, y, iw, ih],\n        });\n\n        return;\n      }\n\n      const sizeOfOrigin = imageRect[2] / imageCache.size[0];\n\n      if (sizeOfOrigin < (imageCache.downSamplingRate || 0.5)) {\n        this.#renderDownSampled(context, parsedStyle, object, {\n          src,\n          imageCache,\n          drawRect: [x, y, iw, ih],\n        });\n\n        return;\n      }\n\n      if (!ImagePool.isSupportTile) {\n        ImageRenderer.renderFull(context, parsedStyle, object, {\n          image,\n          drawRect: [x, y, iw, ih],\n        });\n\n        return;\n      }\n\n      this.#renderTile(context, parsedStyle, object, {\n        src,\n        imageCache,\n        imageRect,\n        drawRect,\n      });\n    } catch {}\n  }\n}\n","import {\n  type CSSRGB,\n  type CanvasContext,\n  type DisplayObject,\n  type GlobalRuntime,\n  type ParsedTextStyleProps,\n  type Rectangle,\n  CSSGradientValue,\n  Pattern,\n} from '@antv/g-lite';\nimport { isNil } from '@antv/util';\nimport { ImagePool } from '@antv/g-plugin-image-loader';\nimport { applyFill, applyStroke, setShadowAndFilter } from './Default';\nimport type { StyleRenderer } from './interfaces';\nimport { CanvasRendererPlugin } from '../../CanvasRendererPlugin';\n\nexport class TextRenderer implements StyleRenderer {\n  constructor(private imagePool: ImagePool) {}\n\n  render(\n    context: CanvasRenderingContext2D,\n    parsedStyle: ParsedTextStyleProps,\n    object: DisplayObject,\n    canvasContext: CanvasContext,\n    plugin: CanvasRendererPlugin,\n    runtime: GlobalRuntime,\n  ) {\n    // Trigger text geometry calculation.\n    object.getBounds();\n    const {\n      lineWidth = 1,\n      textAlign = 'start',\n      textBaseline = 'alphabetic',\n      lineJoin = 'miter',\n      miterLimit = 10,\n      letterSpacing = 0,\n      stroke,\n      fill,\n      fillRule,\n      fillOpacity = 1,\n      strokeOpacity = 1,\n      opacity = 1,\n      metrics,\n      x = 0,\n      y = 0,\n      dx,\n      dy,\n      shadowColor,\n      shadowBlur,\n    } = parsedStyle;\n\n    const { font, lines, height, lineHeight, lineMetrics } = metrics;\n\n    context.font = font;\n    context.lineWidth = lineWidth;\n    context.textAlign = textAlign === 'middle' ? 'center' : textAlign;\n\n    let formattedTextBaseline = textBaseline;\n    if (formattedTextBaseline === 'alphabetic') {\n      formattedTextBaseline = 'bottom';\n    }\n\n    context.lineJoin = lineJoin;\n    if (!isNil(miterLimit)) {\n      context.miterLimit = miterLimit;\n    }\n\n    let linePositionY = y;\n    // handle vertical text baseline\n    if (textBaseline === 'middle') {\n      linePositionY += -height / 2 - lineHeight / 2;\n    } else if (\n      textBaseline === 'bottom' ||\n      textBaseline === 'alphabetic' ||\n      textBaseline === 'ideographic'\n    ) {\n      linePositionY += -height;\n    } else if (textBaseline === 'top' || textBaseline === 'hanging') {\n      linePositionY += -lineHeight;\n    }\n\n    // account for dx & dy\n    const offsetX = x + (dx || 0);\n    linePositionY += dy || 0;\n\n    if (lines.length === 1) {\n      if (formattedTextBaseline === 'bottom') {\n        formattedTextBaseline = 'middle';\n        linePositionY -= 0.5 * height;\n      } else if (formattedTextBaseline === 'top') {\n        formattedTextBaseline = 'middle';\n        linePositionY += 0.5 * height;\n      }\n    }\n    context.textBaseline = formattedTextBaseline;\n\n    const hasShadow = !isNil(shadowColor) && shadowBlur > 0;\n    setShadowAndFilter(object, context, hasShadow);\n\n    // draw lines line by line\n    for (let i = 0; i < lines.length; i++) {\n      const linePositionX = lineWidth / 2 + offsetX;\n      linePositionY += lineHeight;\n\n      // no need to re-position X, cause we already set text align\n      // @see https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/textAlign\n      if (!isNil(stroke) && !(stroke as CSSRGB).isNone && lineWidth) {\n        this.drawLetterSpacing(\n          context,\n          object,\n          lines[i],\n          lineMetrics[i],\n          textAlign,\n          linePositionX,\n          linePositionY,\n          letterSpacing,\n          fill,\n          fillRule,\n          fillOpacity,\n          stroke,\n          strokeOpacity,\n          opacity,\n          true,\n          canvasContext,\n          plugin,\n          runtime,\n        );\n      }\n      if (!isNil(fill)) {\n        this.drawLetterSpacing(\n          context,\n          object,\n          lines[i],\n          lineMetrics[i],\n          textAlign,\n          linePositionX,\n          linePositionY,\n          letterSpacing,\n          fill,\n          fillRule,\n          fillOpacity,\n          stroke,\n          strokeOpacity,\n          opacity,\n          false,\n          canvasContext,\n          plugin,\n          runtime,\n        );\n      }\n    }\n  }\n\n  private drawLetterSpacing(\n    context: CanvasRenderingContext2D,\n    object: DisplayObject,\n    text: string,\n    lineMetrics: Rectangle,\n    textAlign: CanvasTextAlign | 'middle',\n    x: number,\n    y: number,\n    letterSpacing: number,\n    fill: CSSRGB | CSSGradientValue[] | Pattern,\n    fillRule: 'nonzero' | 'evenodd',\n    fillOpacity: number | undefined,\n    stroke: CSSRGB | CSSGradientValue[] | Pattern,\n    strokeOpacity: number | undefined,\n    opacity: number | undefined,\n    isStroke: boolean,\n    canvasContext: CanvasContext,\n    plugin: CanvasRendererPlugin,\n    runtime: GlobalRuntime,\n  ): void {\n    // letterSpacing of 0 means normal, render all texts directly\n    if (letterSpacing === 0) {\n      if (isStroke) {\n        this.strokeText(\n          context,\n          object,\n          text,\n          x,\n          y,\n          stroke,\n          strokeOpacity,\n          canvasContext,\n          plugin,\n          runtime,\n        );\n      } else {\n        this.fillText(\n          context,\n          object,\n          text,\n          x,\n          y,\n          fill,\n          fillRule,\n          fillOpacity,\n          opacity,\n          canvasContext,\n          plugin,\n          runtime,\n        );\n      }\n      return;\n    }\n\n    // draw text using left align\n    const currentTextAlign = context.textAlign;\n    context.textAlign = 'left';\n\n    let currentPosition = x;\n    if (textAlign === 'center' || textAlign === 'middle') {\n      currentPosition = x - lineMetrics.width / 2;\n    } else if (textAlign === 'right' || textAlign === 'end') {\n      currentPosition = x - lineMetrics.width;\n    }\n\n    const stringArray = Array.from(text);\n    let previousWidth = context.measureText(text).width;\n    let currentWidth = 0;\n    for (let i = 0; i < stringArray.length; ++i) {\n      const currentChar = stringArray[i];\n      if (isStroke) {\n        this.strokeText(\n          context,\n          object,\n          currentChar,\n          currentPosition,\n          y,\n          stroke,\n          strokeOpacity,\n          canvasContext,\n          plugin,\n          runtime,\n        );\n      } else {\n        this.fillText(\n          context,\n          object,\n          currentChar,\n          currentPosition,\n          y,\n          fill,\n          fillRule,\n          fillOpacity,\n          opacity,\n          canvasContext,\n          plugin,\n          runtime,\n        );\n      }\n      currentWidth = context.measureText(text.substring(i + 1)).width;\n      currentPosition += previousWidth - currentWidth + letterSpacing;\n      previousWidth = currentWidth;\n    }\n\n    context.textAlign = currentTextAlign;\n  }\n\n  private fillText(\n    context: CanvasRenderingContext2D,\n    object: DisplayObject,\n    text: string,\n    x: number,\n    y: number,\n    fill: CSSRGB | CSSGradientValue[] | Pattern,\n    fillRule: 'nonzero' | 'evenodd',\n    fillOpacity: number | undefined,\n    opacity: number | undefined,\n    canvasContext: CanvasContext,\n    plugin: CanvasRendererPlugin,\n    runtime: GlobalRuntime,\n  ) {\n    applyFill(\n      context,\n      object,\n      fill,\n      fillRule,\n      canvasContext,\n      plugin,\n      runtime,\n      this.imagePool,\n      true,\n    );\n\n    let currentGlobalAlpha: number;\n    const applyOpacity = !isNil(fillOpacity) && fillOpacity !== 1;\n    if (applyOpacity) {\n      currentGlobalAlpha = context.globalAlpha;\n      context.globalAlpha = fillOpacity * opacity;\n    }\n    context.fillText(text, x, y);\n    if (applyOpacity) {\n      context.globalAlpha = currentGlobalAlpha;\n    }\n  }\n\n  private strokeText(\n    context: CanvasRenderingContext2D,\n    object: DisplayObject,\n    text: string,\n    x: number,\n    y: number,\n    stroke: CSSRGB | CSSGradientValue[] | Pattern,\n    strokeOpacity: number | undefined,\n    canvasContext: CanvasContext,\n    plugin: CanvasRendererPlugin,\n    runtime: GlobalRuntime,\n  ) {\n    applyStroke(\n      context,\n      object,\n      stroke,\n      canvasContext,\n      plugin,\n      runtime,\n      this.imagePool,\n      true,\n    );\n\n    let currentGlobalAlpha: number;\n    const applyOpacity = !isNil(strokeOpacity) && strokeOpacity !== 1;\n    if (applyOpacity) {\n      currentGlobalAlpha = context.globalAlpha;\n      context.globalAlpha = strokeOpacity!;\n    }\n    context.strokeText(text, x, y);\n    if (applyOpacity) {\n      context.globalAlpha = currentGlobalAlpha;\n    }\n  }\n}\n","import { DefaultRenderer } from './Default';\n\nexport class RectRenderer extends DefaultRenderer {}\n","import { DefaultRenderer } from './Default';\n\nexport class CircleRenderer extends DefaultRenderer {}\n","import { DefaultRenderer } from './Default';\n\nexport class EllipseRenderer extends DefaultRenderer {}\n","import { DefaultRenderer } from './Default';\n\nexport class LineRenderer extends DefaultRenderer {}\n","import { DefaultRenderer } from './Default';\n\nexport class PolylineRenderer extends DefaultRenderer {}\n","import { DefaultRenderer } from './Default';\n\nexport class PolygonRenderer extends DefaultRenderer {}\n","import { DefaultRenderer } from './Default';\n\nexport class PathRenderer extends DefaultRenderer {}\n","import { AbstractRendererPlugin, Shape } from '@antv/g-lite';\nimport { CanvasRendererPlugin } from './CanvasRendererPlugin';\nimport type { StyleRenderer } from './shapes/styles';\nimport { DefaultRenderer } from './shapes/styles/Default';\nimport { ImageRenderer } from './shapes/styles/Image';\nimport { TextRenderer } from './shapes/styles/Text';\nimport type { CanvasRendererPluginOptions } from './interfaces';\n\nexport * from './shapes/styles';\n\nexport class Plugin extends AbstractRendererPlugin<{\n  defaultStyleRendererFactory: Record<Shape, StyleRenderer>;\n  styleRendererFactory: Record<Shape, StyleRenderer>;\n}> {\n  name = 'canvas-renderer';\n\n  constructor(private options: Partial<CanvasRendererPluginOptions> = {}) {\n    super();\n  }\n\n  init(): void {\n    const canvasRendererPluginOptions: CanvasRendererPluginOptions = {\n      dirtyObjectNumThreshold: 500,\n      dirtyObjectRatioThreshold: 0.8,\n      ...this.options,\n    };\n\n    // @ts-ignore\n    const { imagePool } = this.context;\n\n    const defaultRenderer = new DefaultRenderer(imagePool);\n\n    const defaultStyleRendererFactory: Record<Shape, StyleRenderer> = {\n      [Shape.CIRCLE]: defaultRenderer,\n      [Shape.ELLIPSE]: defaultRenderer,\n      [Shape.RECT]: defaultRenderer,\n      [Shape.IMAGE]: new ImageRenderer(imagePool),\n      [Shape.TEXT]: new TextRenderer(imagePool),\n      [Shape.LINE]: defaultRenderer,\n      [Shape.POLYLINE]: defaultRenderer,\n      [Shape.POLYGON]: defaultRenderer,\n      [Shape.PATH]: defaultRenderer,\n      [Shape.GROUP]: undefined,\n      [Shape.HTML]: undefined,\n      [Shape.MESH]: undefined,\n    };\n\n    this.context.defaultStyleRendererFactory = defaultStyleRendererFactory;\n    this.context.styleRendererFactory = defaultStyleRendererFactory;\n\n    this.addRenderingPlugin(\n      new CanvasRendererPlugin(canvasRendererPluginOptions),\n    );\n  }\n  destroy(): void {\n    this.removeAllRenderingPlugins();\n\n    delete this.context.defaultStyleRendererFactory;\n    delete this.context.styleRendererFactory;\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}