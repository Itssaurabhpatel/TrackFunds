{"ast":null,"code":"/*!\n * @antv/g-plugin-image-loader\n * @description A G plugin for loading image\n * @version 2.0.14\n * @date 10/24/2024, 7:57:36 AM\n * @author AntVis\n * @docs https://g.antv.antgroup.com/\n */\nimport _classCallCheck from '@babel/runtime/helpers/classCallCheck';\nimport _createClass from '@babel/runtime/helpers/createClass';\nimport _callSuper from '@babel/runtime/helpers/callSuper';\nimport _inherits from '@babel/runtime/helpers/inherits';\nimport { OffscreenCanvasCreator, isBrowser, parsedTransformToMat4, parseTransform, DisplayObject, GradientType, computeLinearGradient, computeRadialGradient, UnitType, ElementEvent, Shape, AbstractRendererPlugin } from '@antv/g-lite';\nimport _regeneratorRuntime from '@babel/runtime/helpers/regeneratorRuntime';\nimport _objectSpread from '@babel/runtime/helpers/objectSpread2';\nimport _slicedToArray from '@babel/runtime/helpers/slicedToArray';\nimport _asyncToGenerator from '@babel/runtime/helpers/asyncToGenerator';\nimport { isString } from '@antv/util';\nimport { mat4 } from 'gl-matrix';\nimport _classPrivateFieldLooseBase from '@babel/runtime/helpers/classPrivateFieldLooseBase';\nimport _classPrivateFieldLooseKey from '@babel/runtime/helpers/classPrivateFieldLooseKey';\nvar _cacheStore = /*#__PURE__*/_classPrivateFieldLooseKey(\"cacheStore\");\nvar RefCountCache = /*#__PURE__*/function () {\n  function RefCountCache() {\n    _classCallCheck(this, RefCountCache);\n    Object.defineProperty(this, _cacheStore, {\n      writable: true,\n      value: new Map()\n    });\n  }\n  return _createClass(RefCountCache, [{\n    key: \"has\",\n    value: function has(key) {\n      return _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].has(key);\n    }\n  }, {\n    key: \"put\",\n    value: function put(key, item, ref) {\n      if (_classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].has(key)) {\n        return false;\n      }\n      _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].set(key, {\n        value: item,\n        counter: new Set([ref])\n      });\n      return true;\n    }\n  }, {\n    key: \"get\",\n    value: function get(key, ref) {\n      var cacheItem = _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].get(key);\n      if (!cacheItem) {\n        return null;\n      }\n      cacheItem.counter.add(ref);\n      return cacheItem.value;\n    }\n  }, {\n    key: \"update\",\n    value: function update(key, value, ref) {\n      var cacheItem = _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].get(key);\n      if (!cacheItem) {\n        return false;\n      }\n      cacheItem.value = _objectSpread(_objectSpread({}, cacheItem.value), value);\n      cacheItem.counter.add(ref);\n      return true;\n    }\n  }, {\n    key: \"release\",\n    value: function release(key, ref) {\n      var cacheItem = _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].get(key);\n      if (!cacheItem) {\n        return false;\n      }\n      cacheItem.counter[\"delete\"](ref);\n      if (cacheItem.counter.size <= 0) {\n        _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore][\"delete\"](key);\n      }\n      return true;\n    }\n  }, {\n    key: \"releaseRef\",\n    value: function releaseRef(ref) {\n      var _this = this;\n      _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].keys().forEach(function (key) {\n        _this.release(key, ref);\n      });\n    }\n  }, {\n    key: \"getSize\",\n    value: function getSize() {\n      return _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].size;\n    }\n  }, {\n    key: \"clear\",\n    value: function clear() {\n      _classPrivateFieldLooseBase(this, _cacheStore)[_cacheStore].clear();\n    }\n  }]);\n}();\nvar tasks = [];\nvar nextFrameTasks = [];\nvar ImageSlicer = /*#__PURE__*/function () {\n  function ImageSlicer() {\n    _classCallCheck(this, ImageSlicer);\n  }\n  return _createClass(ImageSlicer, null, [{\n    key: \"stop\",\n    value: function stop() {\n      var api = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : ImageSlicer.api;\n      if (ImageSlicer.rafId) {\n        api.cancelAnimationFrame(ImageSlicer.rafId);\n        ImageSlicer.rafId = null;\n      }\n    }\n  }, {\n    key: \"executeTask\",\n    value: function executeTask() {\n      var api = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : ImageSlicer.api;\n      if (tasks.length <= 0 && nextFrameTasks.length <= 0) {\n        return;\n      }\n      nextFrameTasks.forEach(function (task) {\n        return task();\n      });\n      nextFrameTasks = tasks.splice(0, ImageSlicer.TASK_NUM_PER_FRAME);\n      ImageSlicer.rafId = api.requestAnimationFrame(function () {\n        ImageSlicer.executeTask(api);\n      });\n    }\n  }, {\n    key: \"sliceImage\",\n    value: function sliceImage(image, sliceWidth, sliceHeight) {\n      var overlap = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;\n      var api = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : ImageSlicer.api;\n      var imageWidth = image.naturalWidth || image.width;\n      var imageHeight = image.naturalHeight || image.height;\n\n      // 计算步长(考虑重叠区域)\n      var strideW = sliceWidth - overlap;\n      var strideH = sliceHeight - overlap;\n\n      // 计算网格尺寸\n      var gridCols = Math.ceil(imageWidth / strideW);\n      var gridRows = Math.ceil(imageHeight / strideH);\n      var result = {\n        tileSize: [sliceWidth, sliceHeight],\n        gridSize: [gridRows, gridCols],\n        tiles: Array(gridRows).fill(null).map(function () {\n          return Array(gridCols).fill(null);\n        })\n      };\n\n      // 遍历网格创建切片\n      var _loop = function _loop(row) {\n        var _loop2 = function _loop2(col) {\n          tasks.push(function () {\n            // 计算当前切片的坐标\n            var startX = col * strideW;\n            var startY = row * strideH;\n\n            // 处理最后一列/行的特殊情况\n            var _ref = [Math.min(sliceWidth, imageWidth - startX), Math.min(sliceHeight, imageHeight - startY)],\n              tempSliceWidth = _ref[0],\n              tempSliceHeight = _ref[1];\n\n            // 创建切片canvas\n            var sliceCanvas = api.createCanvas();\n            sliceCanvas.width = sliceWidth;\n            sliceCanvas.height = sliceHeight;\n            var sliceCtx = sliceCanvas.getContext('2d');\n\n            // 将图像部分绘制到切片canvas上\n            sliceCtx.drawImage(image, startX, startY, tempSliceWidth, tempSliceHeight, 0, 0, tempSliceWidth, tempSliceHeight);\n\n            // 存储切片信息\n            result.tiles[row][col] = {\n              x: startX,\n              y: startY,\n              tileX: col,\n              tileY: row,\n              data: sliceCanvas\n            };\n          });\n        };\n        for (var col = 0; col < gridCols; col++) {\n          _loop2(col);\n        }\n      };\n      for (var row = 0; row < gridRows; row++) {\n        _loop(row);\n      }\n      ImageSlicer.stop();\n      ImageSlicer.executeTask();\n      return result;\n    }\n  }]);\n}();\nImageSlicer.TASK_NUM_PER_FRAME = 10;\nvar IMAGE_CACHE = new RefCountCache();\nvar ImagePool = /*#__PURE__*/function () {\n  function ImagePool(context, runtime) {\n    _classCallCheck(this, ImagePool);\n    this.imageCache = {};\n    this.gradientCache = {};\n    this.patternCache = {};\n    this.context = context;\n    this.runtime = runtime;\n  }\n  return _createClass(ImagePool, [{\n    key: \"getImageSync\",\n    value: function getImageSync(src, ref, callback) {\n      var imageSource = isString(src) ? src : src.src;\n      if (IMAGE_CACHE.has(imageSource)) {\n        var imageCache = IMAGE_CACHE.get(imageSource, ref);\n        if (imageCache.img.complete) {\n          callback === null || callback === void 0 || callback(imageCache);\n          return imageCache;\n        }\n      }\n      this.getOrCreateImage(src, ref).then(function (cache) {\n        callback === null || callback === void 0 || callback(cache);\n      })[\"catch\"](function () {\n        //\n      });\n      return null;\n    }\n  }, {\n    key: \"getOrCreateImage\",\n    value: function getOrCreateImage(src, ref) {\n      var imageSource = isString(src) ? src : src.src;\n      if (!isString(src) && !IMAGE_CACHE.has(imageSource)) {\n        var imageCache = {\n          img: src,\n          size: [src.naturalWidth || src.width, src.naturalHeight || src.height],\n          tileSize: calculateImageTileSize(src)\n        };\n        IMAGE_CACHE.put(imageSource, imageCache, ref);\n      }\n      if (IMAGE_CACHE.has(imageSource)) {\n        var _imageCache = IMAGE_CACHE.get(imageSource, ref);\n        if (_imageCache.img.complete) {\n          return Promise.resolve(_imageCache);\n        }\n        return new Promise(function (resolve, reject) {\n          _imageCache.img.addEventListener('load', function () {\n            _imageCache.tileSize = calculateImageTileSize(_imageCache.img);\n            resolve(_imageCache);\n          });\n          _imageCache.img.addEventListener('error', function (ev) {\n            reject(ev);\n          });\n        });\n      }\n\n      // @see https://github.com/antvis/g/issues/938\n      var createImage = this.context.config.createImage;\n      return new Promise(function (resolve, reject) {\n        var image;\n        if (createImage) {\n          image = createImage(imageSource);\n        } else if (isBrowser) {\n          image = new window.Image();\n        }\n        if (image) {\n          var _imageCache2 = {\n            img: image,\n            size: [0, 0],\n            tileSize: calculateImageTileSize(image)\n          };\n          IMAGE_CACHE.put(imageSource, _imageCache2, ref);\n          image.onload = function () {\n            _imageCache2.size = [image.naturalWidth || image.width, image.naturalHeight || image.height];\n            _imageCache2.tileSize = calculateImageTileSize(_imageCache2.img);\n            resolve(_imageCache2);\n          };\n          image.onerror = function (ev) {\n            reject(ev);\n          };\n          image.crossOrigin = 'Anonymous';\n          image.src = imageSource;\n        }\n      });\n    }\n  }, {\n    key: \"createDownSampledImage\",\n    value: function () {\n      var _createDownSampledImage = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(src, ref) {\n        var imageCache, enableLargeImageOptimization, _ref, _ref$maxDownSampledIm, maxDownSampledImageSize, _ref$downSamplingRate, downSamplingRateThreshold, createImageBitmapFunc, _imageCache$size, originWidth, originHeight, resizedImage, downSamplingRate, updateCache;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return this.getOrCreateImage(src, ref);\n            case 2:\n              imageCache = _context.sent;\n              if (!(typeof imageCache.downSamplingRate !== 'undefined')) {\n                _context.next = 5;\n                break;\n              }\n              return _context.abrupt(\"return\", imageCache);\n            case 5:\n              enableLargeImageOptimization = this.context.config.enableLargeImageOptimization;\n              _ref = typeof enableLargeImageOptimization === 'boolean' ? {} : enableLargeImageOptimization, _ref$maxDownSampledIm = _ref.maxDownSampledImageSize, maxDownSampledImageSize = _ref$maxDownSampledIm === void 0 ? 2048 : _ref$maxDownSampledIm, _ref$downSamplingRate = _ref.downSamplingRateThreshold, downSamplingRateThreshold = _ref$downSamplingRate === void 0 ? 0.5 : _ref$downSamplingRate;\n              createImageBitmapFunc = this.runtime.globalThis.createImageBitmap;\n              _imageCache$size = _slicedToArray(imageCache.size, 2), originWidth = _imageCache$size[0], originHeight = _imageCache$size[1];\n              resizedImage = imageCache.img;\n              downSamplingRate = Math.min((maxDownSampledImageSize + maxDownSampledImageSize) / (originWidth + originHeight), Math.max(0.01, Math.min(downSamplingRateThreshold, 0.5)));\n              updateCache = _objectSpread(_objectSpread({}, imageCache), {}, {\n                downSamplingRate: downSamplingRate\n              });\n              IMAGE_CACHE.update(imageCache.img.src, updateCache, ref);\n              if (!createImageBitmapFunc) {\n                _context.next = 25;\n                break;\n              }\n              _context.prev = 14;\n              _context.next = 17;\n              return createImageBitmapFunc(imageCache.img, {\n                resizeWidth: originWidth * downSamplingRate,\n                resizeHeight: originHeight * downSamplingRate\n              });\n            case 17:\n              resizedImage = _context.sent;\n              _context.next = 23;\n              break;\n            case 20:\n              _context.prev = 20;\n              _context.t0 = _context[\"catch\"](14);\n              downSamplingRate = 1;\n            case 23:\n              _context.next = 26;\n              break;\n            case 25:\n              downSamplingRate = 1;\n            case 26:\n              updateCache = _objectSpread(_objectSpread({}, this.getImageSync(src, ref)), {}, {\n                downSampled: resizedImage,\n                downSamplingRate: downSamplingRate\n              });\n              IMAGE_CACHE.update(imageCache.img.src, updateCache, ref);\n              return _context.abrupt(\"return\", updateCache);\n            case 29:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee, this, [[14, 20]]);\n      }));\n      function createDownSampledImage(_x, _x2) {\n        return _createDownSampledImage.apply(this, arguments);\n      }\n      return createDownSampledImage;\n    }()\n  }, {\n    key: \"createImageTiles\",\n    value: function () {\n      var _createImageTiles = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(src, tiles, ref) {\n        var imageCache, _ref$ownerDocument$de, requestAnimationFrame, cancelAnimationFrame, updateCache;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return this.getOrCreateImage(src, ref);\n            case 2:\n              imageCache = _context2.sent;\n              _ref$ownerDocument$de = ref.ownerDocument.defaultView, requestAnimationFrame = _ref$ownerDocument$de.requestAnimationFrame, cancelAnimationFrame = _ref$ownerDocument$de.cancelAnimationFrame;\n              ImageSlicer.api = {\n                requestAnimationFrame: requestAnimationFrame,\n                cancelAnimationFrame: cancelAnimationFrame,\n                createCanvas: function createCanvas() {\n                  return OffscreenCanvasCreator.createCanvas();\n                }\n              };\n              updateCache = _objectSpread(_objectSpread({}, imageCache), ImageSlicer.sliceImage(imageCache.img, imageCache.tileSize[0], imageCache.tileSize[0]));\n              IMAGE_CACHE.update(imageCache.img.src, updateCache, ref);\n              return _context2.abrupt(\"return\", updateCache);\n            case 8:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2, this);\n      }));\n      function createImageTiles(_x3, _x4, _x5) {\n        return _createImageTiles.apply(this, arguments);\n      }\n      return createImageTiles;\n    }()\n  }, {\n    key: \"releaseImage\",\n    value: function releaseImage(src, ref) {\n      IMAGE_CACHE.release(isString(src) ? src : src.src, ref);\n    }\n  }, {\n    key: \"releaseImageRef\",\n    value: function releaseImageRef(ref) {\n      IMAGE_CACHE.releaseRef(ref);\n    }\n  }, {\n    key: \"getOrCreatePatternSync\",\n    value: function getOrCreatePatternSync(object, pattern, context, $offscreenCanvas, dpr, min, callback) {\n      var patternKey = this.generatePatternKey(pattern);\n      if (patternKey && this.patternCache[patternKey]) {\n        return this.patternCache[patternKey];\n      }\n      var image = pattern.image,\n        repetition = pattern.repetition,\n        transform = pattern.transform;\n      var src;\n      var needScaleWithDPR = false;\n      // Image URL\n      if (isString(image)) {\n        var imageCache = this.getImageSync(image, object, callback);\n        src = imageCache === null || imageCache === void 0 ? void 0 : imageCache.img;\n      } else if ($offscreenCanvas) {\n        src = $offscreenCanvas;\n        needScaleWithDPR = true;\n      } else {\n        src = image;\n      }\n\n      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/createPattern\n      var canvasPattern = src && context.createPattern(src, repetition);\n      if (canvasPattern) {\n        var mat;\n        // @see https://developer.mozilla.org/en-US/docs/Web/API/CanvasPattern/setTransform\n        if (transform) {\n          mat = parsedTransformToMat4(parseTransform(transform), new DisplayObject({}));\n        } else {\n          mat = mat4.identity(mat4.create());\n        }\n        if (needScaleWithDPR) {\n          mat4.scale(mat, mat, [1 / dpr, 1 / dpr, 1]);\n        }\n        canvasPattern.setTransform({\n          a: mat[0],\n          b: mat[1],\n          c: mat[4],\n          d: mat[5],\n          e: mat[12] + min[0],\n          f: mat[13] + min[1]\n        });\n      }\n      if (patternKey && canvasPattern) {\n        this.patternCache[patternKey] = canvasPattern;\n      }\n      return canvasPattern;\n    }\n  }, {\n    key: \"getOrCreateGradient\",\n    value: function getOrCreateGradient(params, context) {\n      var key = this.generateGradientKey(params);\n      var type = params.type,\n        steps = params.steps,\n        min = params.min,\n        width = params.width,\n        height = params.height,\n        angle = params.angle,\n        cx = params.cx,\n        cy = params.cy,\n        size = params.size;\n      if (this.gradientCache[key]) {\n        return this.gradientCache[key];\n      }\n      var gradient = null;\n      if (type === GradientType.LinearGradient) {\n        var _computeLinearGradien = computeLinearGradient(min, width, height, angle),\n          x1 = _computeLinearGradien.x1,\n          y1 = _computeLinearGradien.y1,\n          x2 = _computeLinearGradien.x2,\n          y2 = _computeLinearGradien.y2;\n        // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/createLinearGradient\n        gradient = context.createLinearGradient(x1, y1, x2, y2);\n      } else if (type === GradientType.RadialGradient) {\n        var _computeRadialGradien = computeRadialGradient(min, width, height, cx, cy, size),\n          x = _computeRadialGradien.x,\n          y = _computeRadialGradien.y,\n          r = _computeRadialGradien.r;\n        // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/createRadialGradient\n        gradient = context.createRadialGradient(x, y, 0, x, y, r);\n      }\n      if (gradient) {\n        steps.forEach(function (_ref2) {\n          var offset = _ref2.offset,\n            color = _ref2.color;\n          if (offset.unit === UnitType.kPercentage) {\n            var _gradient;\n            (_gradient = gradient) === null || _gradient === void 0 || _gradient.addColorStop(offset.value / 100, color.toString());\n          }\n        });\n        this.gradientCache[key] = gradient;\n      }\n      return this.gradientCache[key];\n    }\n  }, {\n    key: \"generateGradientKey\",\n    value: function generateGradientKey(params) {\n      var type = params.type,\n        min = params.min,\n        width = params.width,\n        height = params.height,\n        steps = params.steps,\n        angle = params.angle,\n        cx = params.cx,\n        cy = params.cy,\n        size = params.size;\n      return \"gradient-\".concat(type, \"-\").concat((angle === null || angle === void 0 ? void 0 : angle.toString()) || 0, \"-\").concat((cx === null || cx === void 0 ? void 0 : cx.toString()) || 0, \"-\").concat((cy === null || cy === void 0 ? void 0 : cy.toString()) || 0, \"-\").concat((size === null || size === void 0 ? void 0 : size.toString()) || 0, \"-\").concat(min[0], \"-\").concat(min[1], \"-\").concat(width, \"-\").concat(height, \"-\").concat(steps.map(function (_ref3) {\n        var offset = _ref3.offset,\n          color = _ref3.color;\n        return \"\".concat(offset).concat(color);\n      }).join('-'));\n    }\n  }, {\n    key: \"generatePatternKey\",\n    value: function generatePatternKey(pattern) {\n      var image = pattern.image,\n        repetition = pattern.repetition;\n      // only generate cache for Image\n      if (isString(image)) {\n        return \"pattern-\".concat(image, \"-\").concat(repetition);\n      }\n      if (image.nodeName === 'rect') {\n        return \"pattern-\".concat(image.entity, \"-\").concat(repetition);\n      }\n    }\n  }]);\n}();\nImagePool.isSupportTile = !!OffscreenCanvasCreator.createCanvas();\nfunction calculateImageTileSize(img) {\n  if (!img.complete) {\n    return [0, 0];\n  }\n  var width = img.naturalWidth || img.width,\n    height = img.naturalHeight || img.height;\n  var tileSize = 256;\n  [256, 512].forEach(function (size) {\n    var rows = Math.ceil(height / size);\n    var cols = Math.ceil(width / size);\n    if (rows * cols < 1e3) {\n      tileSize = size;\n    }\n  });\n  return [tileSize, tileSize];\n}\nvar LoadImagePlugin = /*#__PURE__*/function () {\n  function LoadImagePlugin() {\n    _classCallCheck(this, LoadImagePlugin);\n  }\n  return _createClass(LoadImagePlugin, [{\n    key: \"apply\",\n    value: function apply(context) {\n      var renderingService = context.renderingService,\n        renderingContext = context.renderingContext,\n        imagePool = context.imagePool;\n      var canvas = renderingContext.root.ownerDocument.defaultView;\n      var calculateWithAspectRatio = function calculateWithAspectRatio(object, imageWidth, imageHeight) {\n        var _object$parsedStyle = object.parsedStyle,\n          width = _object$parsedStyle.width,\n          height = _object$parsedStyle.height;\n        if (width && !height) {\n          object.setAttribute('height', imageHeight / imageWidth * width);\n        } else if (!width && height) {\n          object.setAttribute('width', imageWidth / imageHeight * height);\n        }\n      };\n      var handleMounted = function handleMounted(e) {\n        var object = e.target;\n        var nodeName = object.nodeName,\n          attributes = object.attributes;\n        if (nodeName === Shape.IMAGE) {\n          var src = attributes.src,\n            keepAspectRatio = attributes.keepAspectRatio;\n          if (isString(src)) {\n            imagePool.getImageSync(src, object, function (_ref) {\n              var _ref$img = _ref.img,\n                width = _ref$img.width,\n                height = _ref$img.height;\n              if (keepAspectRatio) {\n                calculateWithAspectRatio(object, width, height);\n              }\n\n              // set dirty rectangle flag\n              object.renderable.dirty = true;\n              renderingService.dirtify();\n            });\n          }\n        }\n      };\n      var handleAttributeChanged = function handleAttributeChanged(e) {\n        var object = e.target;\n        var attrName = e.attrName,\n          prevValue = e.prevValue,\n          newValue = e.newValue;\n        if (object.nodeName !== Shape.IMAGE || attrName !== 'src') {\n          return;\n        }\n        if (prevValue !== newValue) {\n          imagePool.releaseImage(prevValue, object);\n        }\n        if (isString(newValue)) {\n          imagePool.getOrCreateImage(newValue, object).then(function (_ref2) {\n            var _ref2$img = _ref2.img,\n              width = _ref2$img.width,\n              height = _ref2$img.height;\n            if (object.attributes.keepAspectRatio) {\n              calculateWithAspectRatio(object, width, height);\n            }\n\n            // set dirty rectangle flag\n            object.renderable.dirty = true;\n            renderingService.dirtify();\n          })[\"catch\"](function () {\n            //\n          });\n        }\n      };\n      function handleDestroy(e) {\n        var object = e.target;\n        if (object.nodeName !== Shape.IMAGE) {\n          return;\n        }\n        imagePool.releaseImageRef(object);\n      }\n      renderingService.hooks.init.tap(LoadImagePlugin.tag, function () {\n        canvas.addEventListener(ElementEvent.MOUNTED, handleMounted);\n        canvas.addEventListener(ElementEvent.ATTR_MODIFIED, handleAttributeChanged);\n        canvas.addEventListener(ElementEvent.DESTROY, handleDestroy);\n      });\n      renderingService.hooks.destroy.tap(LoadImagePlugin.tag, function () {\n        canvas.removeEventListener(ElementEvent.MOUNTED, handleMounted);\n        canvas.removeEventListener(ElementEvent.ATTR_MODIFIED, handleAttributeChanged);\n        canvas.removeEventListener(ElementEvent.DESTROY, handleDestroy);\n      });\n    }\n  }]);\n}();\nLoadImagePlugin.tag = 'LoadImage';\nvar Plugin = /*#__PURE__*/function (_AbstractRendererPlug) {\n  function Plugin() {\n    var _this;\n    _classCallCheck(this, Plugin);\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n    _this = _callSuper(this, Plugin, [].concat(args));\n    _this.name = 'image-loader';\n    return _this;\n  }\n  _inherits(Plugin, _AbstractRendererPlug);\n  return _createClass(Plugin, [{\n    key: \"init\",\n    value: function init(runtime) {\n      // @ts-ignore\n      this.context.imagePool = new ImagePool(this.context, runtime);\n      this.addRenderingPlugin(new LoadImagePlugin());\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      this.removeAllRenderingPlugins();\n    }\n  }]);\n}(AbstractRendererPlugin);\nexport { ImagePool, Plugin };","map":{"version":3,"names":["RefCountCache","_classCallCheck","Object","defineProperty","_cacheStore","writable","value","Map","_createClass","key","has","_classPrivateFieldLooseBase","put","item","ref","set","counter","Set","get","cacheItem","add","update","_objectSpread","release","size","releaseRef","_this","keys","forEach","getSize","clear","tasks","nextFrameTasks","ImageSlicer","stop","api","arguments","length","undefined","rafId","cancelAnimationFrame","executeTask","task","splice","TASK_NUM_PER_FRAME","requestAnimationFrame","sliceImage","image","sliceWidth","sliceHeight","overlap","imageWidth","naturalWidth","width","imageHeight","naturalHeight","height","strideW","strideH","gridCols","Math","ceil","gridRows","result","tileSize","gridSize","tiles","Array","fill","map","_loop","row","_loop2","col","push","startX","startY","_ref","min","tempSliceWidth","tempSliceHeight","sliceCanvas","createCanvas","sliceCtx","getContext","drawImage","x","y","tileX","tileY","data","IMAGE_CACHE","ImagePool","context","runtime","imageCache","gradientCache","patternCache","getImageSync","src","callback","imageSource","isString","img","complete","getOrCreateImage","then","cache","calculateImageTileSize","_imageCache","Promise","resolve","reject","addEventListener","ev","createImage","config","isBrowser","window","Image","_imageCache2","onload","onerror","crossOrigin","_createDownSampledImage","_asyncToGenerator","_regeneratorRuntime","mark","_callee","enableLargeImageOptimization","_ref$maxDownSampledIm","maxDownSampledImageSize","_ref$downSamplingRate","downSamplingRateThreshold","createImageBitmapFunc","_imageCache$size","originWidth","originHeight","resizedImage","downSamplingRate","updateCache","wrap","_callee$","_context","prev","next","sent","abrupt","globalThis","createImageBitmap","_slicedToArray","max","resizeWidth","resizeHeight","t0","downSampled","createDownSampledImage","_x","_x2","apply","_createImageTiles","_callee2","_ref$ownerDocument$de","_callee2$","_context2","ownerDocument","defaultView","OffscreenCanvasCreator","createImageTiles","_x3","_x4","_x5","releaseImage","releaseImageRef","getOrCreatePatternSync","object","pattern","$offscreenCanvas","dpr","patternKey","generatePatternKey","repetition","transform","needScaleWithDPR","canvasPattern","createPattern","mat","parsedTransformToMat4","parseTransform","DisplayObject","mat4","identity","create","scale","setTransform","a","b","c","d","e","f","getOrCreateGradient","params","generateGradientKey","type","steps","angle","cx","cy","gradient","GradientType","LinearGradient","_computeLinearGradien","computeLinearGradient","x1","y1","x2","y2","createLinearGradient","RadialGradient","_computeRadialGradien","computeRadialGradient","r","createRadialGradient","_ref2","offset","color","unit","UnitType","kPercentage","_gradient","addColorStop","toString","concat","_ref3","join","nodeName","entity","isSupportTile","rows","cols","LoadImagePlugin","renderingService","renderingContext","imagePool","canvas","root","calculateWithAspectRatio","_object$parsedStyle","parsedStyle","setAttribute","handleMounted","target","attributes","Shape","IMAGE","keepAspectRatio","_ref$img","renderable","dirty","dirtify","handleAttributeChanged","attrName","prevValue","newValue","_ref2$img","handleDestroy","hooks","init","tap","tag","ElementEvent","MOUNTED","ATTR_MODIFIED","DESTROY","destroy","removeEventListener","Plugin","_AbstractRendererPlug","_len","args","_key","_callSuper","name","_inherits","addRenderingPlugin","removeAllRenderingPlugins","AbstractRendererPlugin"],"sources":["/workspaces/TrackFunds/node_modules/@antv/g-plugin-image-loader/src/RefCountCache.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-image-loader/src/ImageSlicer.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-image-loader/src/ImagePool.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-image-loader/src/LoadImagePlugin.ts","/workspaces/TrackFunds/node_modules/@antv/g-plugin-image-loader/src/index.ts"],"sourcesContent":["export class RefCountCache<CacheValue, CounterValue> {\n  #cacheStore = new Map<\n    string,\n    { value: CacheValue; counter: Set<CounterValue> }\n  >();\n\n  has(key: string) {\n    return this.#cacheStore.has(key);\n  }\n\n  put(key: string, item: CacheValue, ref: CounterValue) {\n    if (this.#cacheStore.has(key)) {\n      return false;\n    }\n\n    this.#cacheStore.set(key, {\n      value: item,\n      counter: new Set([ref]),\n    });\n\n    return true;\n  }\n\n  get(key: string, ref: CounterValue) {\n    const cacheItem = this.#cacheStore.get(key);\n    if (!cacheItem) {\n      return null;\n    }\n\n    cacheItem.counter.add(ref);\n\n    return cacheItem.value;\n  }\n\n  update(key: string, value: CacheValue, ref: CounterValue) {\n    const cacheItem = this.#cacheStore.get(key);\n    if (!cacheItem) {\n      return false;\n    }\n\n    cacheItem.value = { ...cacheItem.value, ...value };\n    cacheItem.counter.add(ref);\n\n    return true;\n  }\n\n  release(key: string, ref: CounterValue) {\n    const cacheItem = this.#cacheStore.get(key);\n    if (!cacheItem) {\n      return false;\n    }\n\n    cacheItem.counter.delete(ref);\n\n    if (cacheItem.counter.size <= 0) {\n      this.#cacheStore.delete(key);\n    }\n\n    return true;\n  }\n\n  releaseRef(ref: CounterValue) {\n    this.#cacheStore.keys().forEach((key) => {\n      this.release(key, ref);\n    });\n  }\n\n  getSize() {\n    return this.#cacheStore.size;\n  }\n\n  clear() {\n    this.#cacheStore.clear();\n  }\n}\n","const tasks: (() => void)[] = [];\nlet nextFrameTasks: (() => void)[] = [];\n\ninterface API {\n  requestAnimationFrame: typeof requestAnimationFrame;\n  cancelAnimationFrame: typeof cancelAnimationFrame;\n  createCanvas: () => HTMLCanvasElement | OffscreenCanvas;\n}\n\nexport interface SliceResult {\n  tileSize: [number, number];\n  /** [rows, cols] */\n  gridSize: [number, number];\n  /**\n   * @example\n   * ```\n   * [\n   *  // tileY=0\n   *  [tileX=0, tileX=1, ...],\n   *  // tileY=1\n   *  [tileX=0, tileX=1, ...],\n   * ]\n   * ```\n   */\n  tiles: (null | {\n    x: number;\n    y: number;\n    tileX: number;\n    tileY: number;\n    data: HTMLCanvasElement | OffscreenCanvas;\n  })[][];\n}\n\nexport class ImageSlicer {\n  static api: API;\n  static TASK_NUM_PER_FRAME = 10;\n  static rafId: ReturnType<typeof requestAnimationFrame>;\n\n  static stop(api = ImageSlicer.api) {\n    if (ImageSlicer.rafId) {\n      api.cancelAnimationFrame(ImageSlicer.rafId);\n      ImageSlicer.rafId = null;\n    }\n  }\n\n  static executeTask(api = ImageSlicer.api) {\n    if (tasks.length <= 0 && nextFrameTasks.length <= 0) {\n      return;\n    }\n\n    nextFrameTasks.forEach((task) => task());\n    nextFrameTasks = tasks.splice(0, ImageSlicer.TASK_NUM_PER_FRAME);\n\n    ImageSlicer.rafId = api.requestAnimationFrame(() => {\n      ImageSlicer.executeTask(api);\n    });\n  }\n\n  static sliceImage(\n    image: HTMLImageElement,\n    sliceWidth: number,\n    sliceHeight: number,\n    overlap = 0,\n    api = ImageSlicer.api,\n  ) {\n    const imageWidth = image.naturalWidth || image.width;\n    const imageHeight = image.naturalHeight || image.height;\n\n    // 计算步长(考虑重叠区域)\n    const strideW = sliceWidth - overlap;\n    const strideH = sliceHeight - overlap;\n\n    // 计算网格尺寸\n    const gridCols = Math.ceil(imageWidth / strideW);\n    const gridRows = Math.ceil(imageHeight / strideH);\n\n    const result: SliceResult = {\n      tileSize: [sliceWidth, sliceHeight],\n      gridSize: [gridRows, gridCols],\n      tiles: Array(gridRows)\n        .fill(null)\n        .map(() => Array(gridCols).fill(null) as SliceResult['tiles'][number]),\n    };\n\n    // 遍历网格创建切片\n    for (let row = 0; row < gridRows; row++) {\n      for (let col = 0; col < gridCols; col++) {\n        tasks.push(() => {\n          // 计算当前切片的坐标\n          const startX = col * strideW;\n          const startY = row * strideH;\n\n          // 处理最后一列/行的特殊情况\n          const [tempSliceWidth, tempSliceHeight] = [\n            Math.min(sliceWidth, imageWidth - startX),\n            Math.min(sliceHeight, imageHeight - startY),\n          ];\n\n          // 创建切片canvas\n          const sliceCanvas = api.createCanvas();\n          sliceCanvas.width = sliceWidth;\n          sliceCanvas.height = sliceHeight;\n          const sliceCtx = sliceCanvas.getContext('2d');\n\n          // 将图像部分绘制到切片canvas上\n          sliceCtx.drawImage(\n            image,\n            startX,\n            startY,\n            tempSliceWidth,\n            tempSliceHeight,\n            0,\n            0,\n            tempSliceWidth,\n            tempSliceHeight,\n          );\n\n          // 存储切片信息\n          result.tiles[row][col] = {\n            x: startX,\n            y: startY,\n            tileX: col,\n            tileY: row,\n            data: sliceCanvas,\n          };\n        });\n      }\n    }\n\n    ImageSlicer.stop();\n    ImageSlicer.executeTask();\n\n    return result;\n  }\n}\n","import {\n  DisplayObject,\n  GradientType,\n  LinearGradient,\n  Pattern,\n  RadialGradient,\n  Rect,\n  Tuple3Number,\n  UnitType,\n  computeLinearGradient,\n  computeRadialGradient,\n  isBrowser,\n  parseTransform,\n  parsedTransformToMat4,\n  Image,\n  OffscreenCanvasCreator,\n  type CanvasContext,\n  type GlobalRuntime,\n} from '@antv/g-lite';\nimport { isString } from '@antv/util';\nimport { mat4 } from 'gl-matrix';\nimport { RefCountCache } from './RefCountCache';\nimport { type SliceResult, ImageSlicer } from './ImageSlicer';\n\nexport interface ImageCache extends Partial<SliceResult> {\n  img: HTMLImageElement;\n  /** [width, height] */\n  size: [number, number];\n  downSampled?: ImageBitmap | HTMLImageElement;\n  downSamplingRate?: number;\n}\n\nconst IMAGE_CACHE = new RefCountCache<ImageCache, DisplayObject>();\n\nexport type GradientParams = (LinearGradient & RadialGradient) & {\n  width: number;\n  height: number;\n  /**\n   * Top-left corner\n   */\n  min: [number, number];\n  type: GradientType;\n};\n\nexport class ImagePool {\n  static isSupportTile = !!OffscreenCanvasCreator.createCanvas();\n  private imageCache: Record<string, HTMLImageElement> = {};\n  private gradientCache: Record<string, CanvasGradient> = {};\n  private patternCache: Record<string, CanvasPattern> = {};\n\n  constructor(\n    public context: CanvasContext,\n    private runtime: GlobalRuntime,\n  ) {}\n\n  getImageSync(\n    src: Image['attributes']['src'],\n    ref: DisplayObject,\n    callback?: (cache: ImageCache) => void,\n  ): ImageCache | null {\n    const imageSource = isString(src) ? src : src.src;\n\n    if (IMAGE_CACHE.has(imageSource)) {\n      const imageCache = IMAGE_CACHE.get(imageSource, ref);\n\n      if (imageCache.img.complete) {\n        callback?.(imageCache);\n\n        return imageCache;\n      }\n    }\n\n    this.getOrCreateImage(src, ref)\n      .then((cache) => {\n        callback?.(cache);\n      })\n      .catch(() => {\n        //\n      });\n\n    return null;\n  }\n\n  getOrCreateImage(\n    src: Image['attributes']['src'],\n    ref: DisplayObject,\n  ): Promise<ImageCache> {\n    const imageSource = isString(src) ? src : src.src;\n\n    if (!isString(src) && !IMAGE_CACHE.has(imageSource)) {\n      const imageCache: ImageCache = {\n        img: src,\n        size: [src.naturalWidth || src.width, src.naturalHeight || src.height],\n        tileSize: calculateImageTileSize(src),\n      };\n\n      IMAGE_CACHE.put(imageSource, imageCache, ref);\n    }\n\n    if (IMAGE_CACHE.has(imageSource)) {\n      const imageCache = IMAGE_CACHE.get(imageSource, ref);\n\n      if (imageCache.img.complete) {\n        return Promise.resolve(imageCache);\n      }\n\n      return new Promise((resolve, reject) => {\n        imageCache.img.addEventListener('load', () => {\n          imageCache.tileSize = calculateImageTileSize(imageCache.img);\n          resolve(imageCache);\n        });\n\n        imageCache.img.addEventListener('error', (ev) => {\n          reject(ev);\n        });\n      });\n    }\n\n    // @see https://github.com/antvis/g/issues/938\n    const { createImage } = this.context.config;\n\n    return new Promise((resolve, reject) => {\n      let image: HTMLImageElement;\n      if (createImage) {\n        image = createImage(imageSource);\n      } else if (isBrowser) {\n        image = new window.Image();\n      }\n\n      if (image) {\n        const imageCache: ImageCache = {\n          img: image,\n          size: [0, 0],\n          tileSize: calculateImageTileSize(image),\n        };\n\n        IMAGE_CACHE.put(imageSource, imageCache, ref);\n\n        image.onload = () => {\n          imageCache.size = [\n            image.naturalWidth || image.width,\n            image.naturalHeight || image.height,\n          ];\n          imageCache.tileSize = calculateImageTileSize(imageCache.img);\n          resolve(imageCache);\n        };\n        image.onerror = (ev) => {\n          reject(ev);\n        };\n        image.crossOrigin = 'Anonymous';\n        image.src = imageSource;\n      }\n    });\n  }\n\n  async createDownSampledImage(\n    src: Image['attributes']['src'],\n    ref: DisplayObject,\n  ): Promise<ImageCache> {\n    const imageCache = await this.getOrCreateImage(src, ref);\n    if (typeof imageCache.downSamplingRate !== 'undefined') {\n      return imageCache;\n    }\n\n    const { enableLargeImageOptimization } = this.context.config;\n    const { maxDownSampledImageSize = 2048, downSamplingRateThreshold = 0.5 } =\n      typeof enableLargeImageOptimization === 'boolean'\n        ? {}\n        : enableLargeImageOptimization;\n    const createImageBitmapFunc = this.runtime.globalThis\n      .createImageBitmap as typeof createImageBitmap;\n    const [originWidth, originHeight] = imageCache.size;\n    let resizedImage: ImageCache['downSampled'] = imageCache.img;\n    let downSamplingRate = Math.min(\n      (maxDownSampledImageSize + maxDownSampledImageSize) /\n        (originWidth + originHeight),\n      Math.max(0.01, Math.min(downSamplingRateThreshold, 0.5)),\n    );\n\n    let updateCache: ImageCache = {\n      ...imageCache,\n      downSamplingRate,\n    };\n\n    IMAGE_CACHE.update(imageCache.img.src, updateCache, ref);\n\n    if (createImageBitmapFunc) {\n      try {\n        resizedImage = await createImageBitmapFunc(imageCache.img, {\n          resizeWidth: originWidth * downSamplingRate,\n          resizeHeight: originHeight * downSamplingRate,\n        });\n      } catch {\n        downSamplingRate = 1;\n      }\n    } else {\n      downSamplingRate = 1;\n    }\n\n    updateCache = {\n      ...this.getImageSync(src, ref),\n      downSampled: resizedImage,\n      downSamplingRate,\n    };\n\n    IMAGE_CACHE.update(imageCache.img.src, updateCache, ref);\n\n    return updateCache;\n  }\n\n  async createImageTiles(\n    src: Image['attributes']['src'],\n    tiles: [number, number][],\n    ref: DisplayObject,\n  ): Promise<ImageCache> {\n    const imageCache = await this.getOrCreateImage(src, ref);\n    const { requestAnimationFrame, cancelAnimationFrame } =\n      ref.ownerDocument.defaultView;\n\n    ImageSlicer.api = {\n      requestAnimationFrame,\n      cancelAnimationFrame,\n      createCanvas: () => OffscreenCanvasCreator.createCanvas(),\n    };\n\n    const updateCache: ImageCache = {\n      ...imageCache,\n      ...ImageSlicer.sliceImage(\n        imageCache.img,\n        imageCache.tileSize[0],\n        imageCache.tileSize[0],\n      ),\n    };\n\n    IMAGE_CACHE.update(imageCache.img.src, updateCache, ref);\n\n    return updateCache;\n  }\n\n  releaseImage(src: Image['attributes']['src'], ref: DisplayObject) {\n    IMAGE_CACHE.release(isString(src) ? src : src.src, ref);\n  }\n\n  releaseImageRef(ref: DisplayObject) {\n    IMAGE_CACHE.releaseRef(ref);\n  }\n\n  getOrCreatePatternSync(\n    object: DisplayObject,\n    pattern: Pattern,\n    context: CanvasRenderingContext2D,\n    $offscreenCanvas: HTMLCanvasElement,\n    dpr: number,\n    min: Tuple3Number,\n    callback: () => void,\n  ) {\n    const patternKey = this.generatePatternKey(pattern);\n    if (patternKey && this.patternCache[patternKey]) {\n      return this.patternCache[patternKey];\n    }\n\n    const { image, repetition, transform } = pattern;\n    let src: CanvasImageSource;\n    let needScaleWithDPR = false;\n    // Image URL\n    if (isString(image)) {\n      const imageCache = this.getImageSync(image, object, callback);\n      src = imageCache?.img;\n    } else if ($offscreenCanvas) {\n      src = $offscreenCanvas;\n      needScaleWithDPR = true;\n    } else {\n      src = image as CanvasImageSource;\n    }\n\n    // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/createPattern\n    const canvasPattern = src && context.createPattern(src, repetition);\n\n    if (canvasPattern) {\n      let mat: mat4;\n      // @see https://developer.mozilla.org/en-US/docs/Web/API/CanvasPattern/setTransform\n      if (transform) {\n        mat = parsedTransformToMat4(\n          parseTransform(transform),\n          new DisplayObject({}),\n        );\n      } else {\n        mat = mat4.identity(mat4.create());\n      }\n\n      if (needScaleWithDPR) {\n        mat4.scale(mat, mat, [1 / dpr, 1 / dpr, 1]);\n      }\n\n      canvasPattern.setTransform({\n        a: mat[0],\n        b: mat[1],\n        c: mat[4],\n        d: mat[5],\n        e: mat[12] + min[0],\n        f: mat[13] + min[1],\n      });\n    }\n\n    if (patternKey && canvasPattern) {\n      this.patternCache[patternKey] = canvasPattern;\n    }\n\n    return canvasPattern;\n  }\n\n  getOrCreateGradient(\n    params: GradientParams,\n    context: CanvasRenderingContext2D,\n  ) {\n    const key = this.generateGradientKey(params);\n    const { type, steps, min, width, height, angle, cx, cy, size } = params;\n\n    if (this.gradientCache[key]) {\n      return this.gradientCache[key];\n    }\n\n    let gradient: CanvasGradient | null = null;\n    if (type === GradientType.LinearGradient) {\n      const { x1, y1, x2, y2 } = computeLinearGradient(\n        min,\n        width,\n        height,\n        angle,\n      );\n      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/createLinearGradient\n      gradient = context.createLinearGradient(x1, y1, x2, y2);\n    } else if (type === GradientType.RadialGradient) {\n      const { x, y, r } = computeRadialGradient(\n        min,\n        width,\n        height,\n        cx,\n        cy,\n        size,\n      );\n      // @see https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/createRadialGradient\n      gradient = context.createRadialGradient(x, y, 0, x, y, r);\n    }\n\n    if (gradient) {\n      steps.forEach(({ offset, color }) => {\n        if (offset.unit === UnitType.kPercentage) {\n          gradient?.addColorStop(offset.value / 100, color.toString());\n        }\n      });\n\n      this.gradientCache[key] = gradient;\n    }\n\n    return this.gradientCache[key];\n  }\n\n  private generateGradientKey(params: GradientParams): string {\n    const { type, min, width, height, steps, angle, cx, cy, size } = params;\n    return `gradient-${type}-${angle?.toString() || 0}-${cx?.toString() || 0}-${\n      cy?.toString() || 0\n    }-${size?.toString() || 0}-${min[0]}-${min[1]}-${width}-${height}-${steps\n      .map(({ offset, color }) => `${offset}${color}`)\n      .join('-')}`;\n  }\n\n  private generatePatternKey(pattern: Pattern) {\n    const { image, repetition } = pattern;\n    // only generate cache for Image\n    if (isString(image)) {\n      return `pattern-${image}-${repetition}`;\n    }\n    if ((image as Rect).nodeName === 'rect') {\n      return `pattern-${(image as Rect).entity}-${repetition}`;\n    }\n  }\n}\n\nfunction calculateImageTileSize(img: HTMLImageElement): [number, number] {\n  if (!img.complete) {\n    return [0, 0];\n  }\n\n  const [width, height] = [\n    img.naturalWidth || img.width,\n    img.naturalHeight || img.height,\n  ];\n\n  let tileSize = 256;\n\n  [256, 512].forEach((size) => {\n    const rows = Math.ceil(height / size);\n    const cols = Math.ceil(width / size);\n\n    if (rows * cols < 1e3) {\n      tileSize = size;\n    }\n  });\n\n  return [tileSize, tileSize];\n}\n","import type {\n  FederatedEvent,\n  Image,\n  MutationEvent,\n  RenderingPlugin,\n  RenderingPluginContext,\n} from '@antv/g-lite';\nimport { ElementEvent, Shape } from '@antv/g-lite';\nimport { isString } from '@antv/util';\nimport { ImagePool } from './ImagePool';\n\nexport class LoadImagePlugin implements RenderingPlugin {\n  static tag = 'LoadImage';\n\n  apply(context: RenderingPluginContext & { imagePool: ImagePool }) {\n    const { renderingService, renderingContext, imagePool } = context;\n    const canvas = renderingContext.root.ownerDocument.defaultView;\n\n    const calculateWithAspectRatio = (\n      object: Image,\n      imageWidth: number,\n      imageHeight: number,\n    ) => {\n      const { width, height } = object.parsedStyle;\n      if (width && !height) {\n        object.setAttribute('height', (imageHeight / imageWidth) * width);\n      } else if (!width && height) {\n        object.setAttribute('width', (imageWidth / imageHeight) * height);\n      }\n    };\n\n    const handleMounted = (e: FederatedEvent) => {\n      const object = e.target as Image;\n      const { nodeName, attributes } = object;\n      if (nodeName === Shape.IMAGE) {\n        const { src, keepAspectRatio } = attributes;\n\n        if (isString(src)) {\n          imagePool.getImageSync(src, object, ({ img: { width, height } }) => {\n            if (keepAspectRatio) {\n              calculateWithAspectRatio(object, width, height);\n            }\n\n            // set dirty rectangle flag\n            object.renderable.dirty = true;\n            renderingService.dirtify();\n          });\n        }\n      }\n    };\n\n    const handleAttributeChanged = (e: MutationEvent) => {\n      const object = e.target as Image;\n      const { attrName, prevValue, newValue } = e;\n\n      if (object.nodeName !== Shape.IMAGE || attrName !== 'src') {\n        return;\n      }\n\n      if (prevValue !== newValue) {\n        imagePool.releaseImage(prevValue as Image['attributes']['src'], object);\n      }\n\n      if (isString(newValue)) {\n        imagePool\n          .getOrCreateImage(newValue, object)\n          .then(({ img: { width, height } }) => {\n            if (object.attributes.keepAspectRatio) {\n              calculateWithAspectRatio(object, width, height);\n            }\n\n            // set dirty rectangle flag\n            object.renderable.dirty = true;\n            renderingService.dirtify();\n          })\n          .catch(() => {\n            //\n          });\n      }\n    };\n\n    function handleDestroy(e: FederatedEvent) {\n      const object = e.target as Image;\n\n      if (object.nodeName !== Shape.IMAGE) {\n        return;\n      }\n\n      imagePool.releaseImageRef(object);\n    }\n\n    renderingService.hooks.init.tap(LoadImagePlugin.tag, () => {\n      canvas.addEventListener(ElementEvent.MOUNTED, handleMounted);\n      canvas.addEventListener(\n        ElementEvent.ATTR_MODIFIED,\n        handleAttributeChanged,\n      );\n      canvas.addEventListener(ElementEvent.DESTROY, handleDestroy);\n    });\n\n    renderingService.hooks.destroy.tap(LoadImagePlugin.tag, () => {\n      canvas.removeEventListener(ElementEvent.MOUNTED, handleMounted);\n      canvas.removeEventListener(\n        ElementEvent.ATTR_MODIFIED,\n        handleAttributeChanged,\n      );\n      canvas.removeEventListener(ElementEvent.DESTROY, handleDestroy);\n    });\n  }\n}\n","import { AbstractRendererPlugin, type GlobalRuntime } from '@antv/g-lite';\nimport { ImagePool, type ImageCache } from './ImagePool';\nimport { LoadImagePlugin } from './LoadImagePlugin';\n\nexport { ImagePool, type ImageCache };\n\nexport class Plugin extends AbstractRendererPlugin {\n  name = 'image-loader';\n  init(runtime: GlobalRuntime): void {\n    // @ts-ignore\n    this.context.imagePool = new ImagePool(this.context, runtime);\n    this.addRenderingPlugin(new LoadImagePlugin());\n  }\n  destroy(): void {\n    this.removeAllRenderingPlugins();\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}